<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Linuxçš„IOå¤ç”¨ä¹‹select | å²ç‰æµ©çš„ä¸ªäººåšå®¢</title>
<meta name="keywords" content="Linux">
<meta name="description" content="select() å‡½æ•°ä½œä¸ºä¸€ç§ç»å…¸çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚å¥—æ¥å­—ï¼‰æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚è™½ç„¶å·²ç»è¿‡æ—¶ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿›ä¸€æ­¥äº†è§£å…¶ä»–å¤ç”¨æœ‰æå¤§çš„å¸®åŠ©ã€‚">
<meta name="author" content="å²ç‰æµ©">
<link rel="canonical" href="https://oheyu.github.io/zh/posts/tech/linux%E7%9A%84io%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9c78afd72529c14d4d3c0fa583c3e82265e0d8a303d475223d3b37442260ba22.css" integrity="sha256-nHiv1yUpwU1NPA&#43;lg8PoImXg2KMD1HUiPTs3RCJguiI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://oheyu.github.io/img/logo.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://oheyu.github.io/img/logo.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://oheyu.github.io/img/logo.svg">
<link rel="apple-touch-icon" href="https://oheyu.github.io/logo.svg">
<link rel="mask-icon" href="https://oheyu.github.io/logo.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://oheyu.github.io/zh/posts/tech/linux%E7%9A%84io%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

  

<meta property="og:title" content="Linuxçš„IOå¤ç”¨ä¹‹select" />
<meta property="og:description" content="select() å‡½æ•°ä½œä¸ºä¸€ç§ç»å…¸çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚å¥—æ¥å­—ï¼‰æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚è™½ç„¶å·²ç»è¿‡æ—¶ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿›ä¸€æ­¥äº†è§£å…¶ä»–å¤ç”¨æœ‰æå¤§çš„å¸®åŠ©ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://oheyu.github.io/zh/posts/tech/linux%E7%9A%84io%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-19T20:19:02+08:00" />
<meta property="article:modified_time" content="2024-03-19T20:19:02+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linuxçš„IOå¤ç”¨ä¹‹select"/>
<meta name="twitter:description" content="select() å‡½æ•°ä½œä¸ºä¸€ç§ç»å…¸çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚å¥—æ¥å­—ï¼‰æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚è™½ç„¶å·²ç»è¿‡æ—¶ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿›ä¸€æ­¥äº†è§£å…¶ä»–å¤ç”¨æœ‰æå¤§çš„å¸®åŠ©ã€‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://oheyu.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://oheyu.github.io/zh/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Linuxçš„IOå¤ç”¨ä¹‹select",
      "item": "https://oheyu.github.io/zh/posts/tech/linux%E7%9A%84io%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Linuxçš„IOå¤ç”¨ä¹‹select",
  "name": "Linuxçš„IOå¤ç”¨ä¹‹select",
  "description": "select() å‡½æ•°ä½œä¸ºä¸€ç§ç»å…¸çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚å¥—æ¥å­—ï¼‰æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚è™½ç„¶å·²ç»è¿‡æ—¶ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿›ä¸€æ­¥äº†è§£å…¶ä»–å¤ç”¨æœ‰æå¤§çš„å¸®åŠ©ã€‚",
  "keywords": [
    "Linux"
  ],
  "articleBody": "\rselect() å‡½æ•°ä½œä¸ºä¸€ç§ç»å…¸çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚å¥—æ¥å­—ï¼‰æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚è™½ç„¶å·²ç»è¿‡æ—¶ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿›ä¸€æ­¥äº†è§£å…¶ä»–å¤ç”¨æœ‰æå¤§çš„å¸®åŠ©ã€‚\nä¸€ã€ä»€ä¹ˆæ˜¯ select() å‡½æ•°ï¼Ÿ select() æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½äº POSIX æ ‡å‡†ä¸­ï¼Œä¸»è¦ç”¨äºç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥æ£€æµ‹å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œï¼ˆå¦‚è¯»ã€å†™æˆ–å‘ç”Ÿå¼‚å¸¸ï¼‰ã€‚å®ƒå…è®¸ç¨‹åºåœ¨å•ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä¸­åŒæ—¶å¤„ç†å¤šä¸ª I/O äº‹ä»¶ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„èµ„æºåˆ©ç”¨ã€‚\n1 2 3 #include int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout); nfdsï¼šéœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„å€¼åŠ ä¸€ã€‚ readfdsï¼šæŒ‡å‘ fd_set ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºç›‘è§†å¯è¯»äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚ writefdsï¼šæŒ‡å‘ fd_set ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºç›‘è§†å¯å†™äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚ exceptfdsï¼šæŒ‡å‘ fd_set ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºç›‘è§†å¼‚å¸¸äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚ timeoutï¼šæŒ‡å‘ timeval ç»“æ„çš„æŒ‡é’ˆï¼ŒæŒ‡å®š select() å‡½æ•°çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœä¸º NULLï¼Œselect() ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚ è¿”å›å€¼ æ­£æ•°ï¼šè¡¨ç¤ºå‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚ 0ï¼šè¡¨ç¤º select() è¶…æ—¶ï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿã€‚ -1ï¼šè¡¨ç¤ºè°ƒç”¨å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯å­˜å‚¨åœ¨ errno ä¸­ã€‚ äºŒã€select() çš„å·¥ä½œåŸç† select() çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ˆfd_setï¼‰æ¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å˜åŒ–ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤å·¥ä½œï¼š\nåˆå§‹åŒ–æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼šä½¿ç”¨ FD_ZERO æ¸…ç©ºé›†åˆï¼Œä½¿ç”¨ FD_SET å°†éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥é›†åˆã€‚ è°ƒç”¨ select()ï¼šå°†å‡†å¤‡å¥½çš„ fd_set ä¼ é€’ç»™ select()ï¼Œå¹¶æŒ‡å®šç›‘è§†çš„äº‹ä»¶ç±»å‹ï¼ˆè¯»ã€å†™ã€å¼‚å¸¸ï¼‰ã€‚ ç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼šselect() ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ–‡ä»¶æè¿°ç¬¦æ»¡è¶³æŒ‡å®šçš„äº‹ä»¶ï¼Œæˆ–è¶…æ—¶æ—¶é—´åˆ°è¾¾ã€‚ å¤„ç†äº‹ä»¶ï¼šselect() è¿”å›åï¼Œéå†æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä½¿ç”¨ FD_ISSET åˆ¤æ–­å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†äº‹ä»¶ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ æ³¨æ„ï¼šselect() ä¼šä¿®æ”¹ä¼ å…¥çš„ fd_set é›†åˆï¼Œä»…ä¿ç•™å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ select() å‰ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–æˆ–å¤åˆ¶åŸå§‹çš„ fd_setã€‚\nä¸‰ã€select() çš„ä½¿ç”¨æ–¹æ³• ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºäº select() çš„ç®€å• TCP æœåŠ¡å™¨ç¤ºä¾‹ï¼Œèƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶å›æ˜¾å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 #include #include #include #include #include #include #include #include #define BUFFER_SIZE 1024 // åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£ã€‚ int initserver(int port); int main(int argc, char *argv[]) { if (argc != 2) { fprintf(stderr, \"Usage: %s \\n\", argv[0]); return EXIT_FAILURE; } // åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socketã€‚ int listensock = initserver(atoi(argv[1])); if (listensock \u003c 0) { fprintf(stderr, \"initserver() failed.\\n\"); return EXIT_FAILURE; } printf(\"Listening on socket=%d\\n\", listensock); fd_set readfds; FD_ZERO(\u0026readfds); FD_SET(listensock, \u0026readfds); int maxfd = listensock; while (1) // äº‹ä»¶å¾ªç¯ã€‚ { struct timeval timeout; timeout.tv_sec = 10; // ç§’ timeout.tv_usec = 0; // å¾®ç§’ã€‚ fd_set tmpfds = readfds; // å¤åˆ¶ readfdsï¼Œé¿å…è¢« select() ä¿®æ”¹ // è°ƒç”¨select() ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼ˆç›‘è§†å“ªäº›socketå‘ç”Ÿäº†äº‹ä»¶)ã€‚ int infds = select(maxfd + 1, \u0026tmpfds, NULL, NULL, \u0026timeout); // å¦‚æœinfds\u003c0ï¼Œè¡¨ç¤ºè°ƒç”¨select()å¤±è´¥ã€‚ if (infds \u003c 0) { if (errno == EINTR) { // è¢«ä¿¡å·ä¸­æ–­ï¼Œç»§ç»­å¾ªç¯ continue; } perror(\"select() failed\"); break; } // å¦‚æœinfds==0ï¼Œè¡¨ç¤ºselect()è¶…æ—¶ã€‚ if (infds == 0) { printf(\"select() timeout.\\n\"); continue; } // å¦‚æœinfds\u003e0ï¼Œè¡¨ç¤ºæœ‰äº‹ä»¶å‘ç”Ÿï¼Œinfdså­˜æ”¾äº†å·²å‘ç”Ÿäº‹ä»¶çš„ä¸ªæ•°ã€‚ for (int eventfd = 0; eventfd \u003c= maxfd \u0026\u0026 infds \u003e 0; eventfd++) { if (FD_ISSET(eventfd, \u0026tmpfds)) { infds--; // å¦‚æœå‘ç”Ÿäº‹ä»¶çš„æ˜¯listensockï¼Œè¡¨ç¤ºæœ‰æ–°çš„å®¢æˆ·ç«¯è¿ä¸Šæ¥äº†ã€‚ if (eventfd == listensock) { struct sockaddr_in client; socklen_t len = sizeof(client); int clientsock = accept(listensock, (struct sockaddr*)\u0026client, \u0026len); if (clientsock \u003c 0) { perror(\"accept() failed\"); continue; } printf(\"Accepted client(socket=%d) from %s:%d.\\n\", clientsock, inet_ntoa(client.sin_addr), ntohs(client.sin_port)); FD_SET(clientsock, \u0026readfds); // æŠŠæ–°è¿ä¸Šæ¥çš„å®¢æˆ·ç«¯çš„æ ‡å¿—ä½ç½®ä¸º1ã€‚ if (clientsock \u003e maxfd) maxfd = clientsock; // æ›´æ–°maxfdçš„å€¼ã€‚ } else { // å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥çš„socketæœ‰äº‹ä»¶ï¼Œè¡¨ç¤ºæ¥æ”¶ç¼“å­˜ä¸­æœ‰æ•°æ®å¯ä»¥è¯»ï¼Œæˆ–è€…æœ‰å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ã€‚ char buffer[BUFFER_SIZE]; memset(buffer, 0, sizeof(buffer)); ssize_t bytes_received = recv(eventfd, buffer, sizeof(buffer) - 1, 0); if (bytes_received \u003c= 0) { if (bytes_received == 0) { // å®¢æˆ·ç«¯å…³é—­è¿æ¥ printf(\"Client(socket=%d) disconnected.\\n\", eventfd); } else { perror(\"recv() failed\"); } close(eventfd); // å…³é—­å®¢æˆ·ç«¯çš„socket FD_CLR(eventfd, \u0026readfds); // æŠŠbitmapä¸­å·²å…³é—­å®¢æˆ·ç«¯çš„æ ‡å¿—ä½æ¸…ç©ºã€‚ if (eventfd == maxfd) // é‡æ–°è®¡ç®—maxfdçš„å€¼ï¼Œåªæœ‰å½“eventfd==maxfdæ—¶æ‰éœ€è¦è®¡ç®—ã€‚ { while (FD_ISSET(maxfd, \u0026readfds) == 0 \u0026\u0026 maxfd \u003e listensock) { maxfd--; } } } else { // å¦‚æœå®¢æˆ·ç«¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥ã€‚ buffer[bytes_received] = '\\0'; // ç¡®ä¿å­—ç¬¦ä¸²ç»ˆæ­¢ printf(\"Received from socket=%d: %s\\n\", eventfd, buffer); // æŠŠæ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹åŸå°ä¸åŠ¨çš„å‘å›å»ã€‚ ssize_t bytes_sent = send(eventfd, buffer, bytes_received, 0); if (bytes_sent \u003c 0) { perror(\"send() failed\"); close(eventfd); // å…³é—­å®¢æˆ·ç«¯çš„socket FD_CLR(eventfd, \u0026readfds); // æŠŠbitmapä¸­å·²å…³é—­å®¢æˆ·ç«¯çš„æ ‡å¿—ä½æ¸…ç©ºã€‚ if (eventfd == maxfd) { while (FD_ISSET(maxfd, \u0026readfds) == 0 \u0026\u0026 maxfd \u003e listensock) { maxfd--; } } } else { printf(\"Echoed back to socket=%d.\\n\", eventfd); } } } } } } close(listensock); // ç¨‹åºç»“æŸå‰å…³é—­ç›‘å¬socket return 0; } // åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£ã€‚ int initserver(int port) { int sock = socket(AF_INET, SOCK_STREAM, 0); if (sock \u003c 0) { perror(\"socket() failed\"); return -1; } int opt = 1; unsigned int len = sizeof(opt); if (setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, \u0026opt, len) \u003c 0) { perror(\"setsockopt() failed\"); close(sock); return -1; } struct sockaddr_in servaddr; memset(\u0026servaddr, 0, sizeof(servaddr)); servaddr.sin_family = AF_INET; servaddr.sin_addr.s_addr = htonl(INADDR_ANY); servaddr.sin_port = htons(port); if (bind(sock, (struct sockaddr *)\u0026servaddr, sizeof(servaddr)) \u003c 0) { perror(\"bind() failed\"); close(sock); return -1; } if (listen(sock, 5) != 0) { perror(\"listen() failed\"); close(sock); return -1; } return sock; } ä»£ç è¯¦è§£\nåˆå§‹åŒ–æœåŠ¡å™¨å¥—æ¥å­—ï¼š\nåˆ›å»ºå¥—æ¥å­—ï¼šä½¿ç”¨ socket(AF_INET, SOCK_STREAM, 0) åˆ›å»ºä¸€ä¸ª TCP å¥—æ¥å­—ã€‚ è®¾ç½®å¥—æ¥å­—é€‰é¡¹ï¼šé€šè¿‡ setsockopt è®¾ç½® SO_REUSEADDR é€‰é¡¹ï¼Œå…è®¸é‡ç”¨æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œé¿å…åœ¨æœåŠ¡å™¨é‡å¯åå‡ºç° bind å¤±è´¥çš„æƒ…å†µã€‚ ç»‘å®šåœ°å€å’Œç«¯å£ï¼šå°†å¥—æ¥å­—ç»‘å®šåˆ°æŒ‡å®šç«¯å£å’Œæ‰€æœ‰å¯ç”¨æ¥å£ (INADDR_ANY)ã€‚ ç›‘å¬ï¼šå°†å¥—æ¥å­—ç½®äºç›‘å¬çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚ åˆå§‹åŒ– fd_set é›†åˆï¼š\nä½¿ç”¨ FD_ZERO æ¸…ç©º readfds é›†åˆã€‚ ä½¿ç”¨ FD_SET å°†ç›‘å¬å¥—æ¥å­—åŠ å…¥ readfds é›†åˆã€‚ ç»´æŠ¤ä¸€ä¸ªå˜é‡ maxfdï¼Œè®°å½•å½“å‰ç›‘è§†çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼ï¼Œç”¨äº select() å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ äº‹ä»¶å¾ªç¯ï¼š\nè¶…æ—¶è®¾ç½®ï¼šå®šä¹‰ä¸€ä¸ª timeval ç»“æ„ä½“ï¼Œè®¾ç½® select() çš„è¶…æ—¶æ—¶é—´ä¸º 10 ç§’ã€‚ å¤åˆ¶ fd_setï¼šæ¯æ¬¡è°ƒç”¨ select() å‰ï¼Œå°†åŸå§‹çš„ readfds é›†åˆå¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶çš„ tmpfds é›†åˆï¼Œå› ä¸º select() ä¼šä¿®æ”¹ä¼ å…¥çš„é›†åˆã€‚ è°ƒç”¨ select()ï¼šç›‘è§†è¯»äº‹ä»¶ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿæˆ–è¶…æ—¶ã€‚ å¤„ç†äº‹ä»¶ï¼š æ–°è¿æ¥äº‹ä»¶ï¼šå¦‚æœç›‘å¬å¥—æ¥å­—æœ‰äº‹ä»¶ï¼Œè°ƒç”¨ accept() æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°†æ–°å®¢æˆ·ç«¯çš„å¥—æ¥å­—åŠ å…¥ readfds é›†åˆï¼Œå¹¶æ›´æ–° maxfdã€‚ æ•°æ®æ¥æ”¶äº‹ä»¶ï¼šå¦‚æœå·²æœ‰å®¢æˆ·ç«¯å¥—æ¥å­—æœ‰äº‹ä»¶ï¼Œè°ƒç”¨ recv() æ¥æ”¶æ•°æ®ã€‚å¦‚æœ recv() è¿”å›å€¼ \u003c= 0ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œå…³é—­å¥—æ¥å­—å¹¶ä» readfds ä¸­ç§»é™¤ï¼›å¦åˆ™ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®å›æ˜¾ç»™å®¢æˆ·ç«¯ã€‚ èµ„æºç®¡ç†ï¼š\nåœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œå…³é—­ç›¸åº”çš„å¥—æ¥å­—å¹¶ä» readfds ä¸­ç§»é™¤ï¼Œé˜²æ­¢èµ„æºæ³„æ¼ã€‚ ç¨‹åºç»“æŸå‰ï¼Œå…³é—­ç›‘å¬å¥—æ¥å­—ï¼Œé‡Šæ”¾èµ„æºã€‚ 3.1 å…³é”®ç‚¹è§£æ ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶ readfds ç»™ tmpfds select() å‡½æ•°ä¼šä¿®æ”¹ä¼ å…¥çš„ fd_set é›†åˆï¼Œä»…ä¿ç•™å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ select() å‰ï¼Œéœ€è¦å°†åŸå§‹çš„ readfds å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶é›†åˆ tmpfdsï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­ä»èƒ½ç›‘è§†æ‰€æœ‰éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦ã€‚\n1 2 fd_set tmpfds = readfds; int infds = select(maxfd + 1, \u0026tmpfds, NULL, NULL, \u0026timeout); å¦åˆ™ï¼Œå¦‚æœç›´æ¥ä¼ å…¥ readfdsï¼Œæ¯æ¬¡ select() è°ƒç”¨åï¼Œreadfds åªä¼šåŒ…å«å‘ç”Ÿäº†äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ— æ³•ç»§ç»­ç›‘è§†å…¶ä»–å¥—æ¥å­—ã€‚\nç»´æŠ¤ maxfd select() çš„ç¬¬ä¸€ä¸ªå‚æ•° nfds éœ€è¦è®¾ç½®ä¸ºæ‰€æœ‰ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ä¸­æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦å€¼åŠ ä¸€ã€‚å› æ­¤ï¼Œæ¯æ¬¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œéœ€è¦æ›´æ–° maxfdï¼š\n1 if (clientsock \u003e maxfd) maxfd = clientsock; å½“æœ‰å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¸”è¯¥å¥—æ¥å­—æ˜¯å½“å‰ maxfd æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ–°çš„ maxfdï¼š\n1 2 3 4 5 6 7 if (eventfd == maxfd) { while (FD_ISSET(maxfd, \u0026readfds) == 0 \u0026\u0026 maxfd \u003e listensock) { maxfd--; } } è¶…æ—¶å¤„ç† åœ¨åŸå§‹ä»£ç ä¸­ï¼Œè™½ç„¶å®šä¹‰äº† timeoutï¼Œä½†ä¼ å…¥ select() çš„å‚æ•°æ˜¯ 0ï¼Œè¡¨ç¤ºæ— é™ç­‰å¾…ã€‚æ­£ç¡®çš„åšæ³•æ˜¯å°† \u0026timeout ä¼ å…¥ select()ï¼Œä»¥å®ç°è¶…æ—¶æœºåˆ¶ã€‚\n1 int infds = select(maxfd + 1, \u0026tmpfds, NULL, NULL, \u0026timeout); è¿™æ ·ï¼Œå½“è¶…è¿‡ 10 ç§’æ²¡æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œselect() ä¼šè¿”å› 0ï¼Œç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œå¦‚æ‰“å°è¶…æ—¶ä¿¡æ¯ã€‚\nç¼“å†²åŒºå®‰å…¨ åœ¨æ¥æ”¶æ•°æ®åï¼Œæ‰‹åŠ¨æ·»åŠ  null å­—ç¬¦ï¼Œç¡®ä¿å­—ç¬¦ä¸²å®‰å…¨ï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€‚\n1 buffer[bytes_received] = '\\0'; // ç¡®ä¿å­—ç¬¦ä¸²ç»ˆæ­¢ åŒæ—¶ï¼Œrecv() è°ƒç”¨ä¸­ï¼Œä½¿ç”¨ sizeof(buffer) - 1 ä½œä¸ºæ¥æ”¶é•¿åº¦ï¼Œç•™å‡ºä¸€ä¸ªå­—èŠ‚ç”¨äºå­˜å‚¨ null å­—ç¬¦ã€‚\né”™è¯¯å¤„ç† åœ¨å¥—æ¥å­—æ“ä½œä¸­ï¼Œåˆç†å¤„ç†é”™è¯¯æƒ…å†µï¼Œå¦‚ accept()ã€recv()ã€send() å¤±è´¥æ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é‡‡å–ç›¸åº”çš„æªæ–½ï¼ˆå¦‚å…³é—­å¥—æ¥å­—ã€ç§»é™¤é›†åˆç­‰ï¼‰ï¼Œç¡®ä¿ç¨‹åºçš„å¥å£®æ€§ã€‚\nå››ã€select() çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ ç®€å•æ˜“ç”¨ï¼šselect() æ˜¯ä¸€ç§ç›¸å¯¹ç®€å•çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæ˜“äºç†è§£å’Œå®ç°ã€‚ è·¨å¹³å°æ”¯æŒï¼šselect() åœ¨å¤§å¤šæ•° POSIX ç³»ç»Ÿï¼ˆå¦‚ Linuxã€BSDã€macOSï¼‰å’Œ Windows å¹³å°ä¸Šéƒ½æœ‰å®ç°ï¼Œå…·æœ‰è‰¯å¥½çš„è·¨å¹³å°å…¼å®¹æ€§ã€‚ æ— éœ€é¢å¤–åº“ï¼šä½¿ç”¨ select() ä¸éœ€è¦ä¾èµ–é¢å¤–çš„åº“ï¼Œé€‚ç”¨äºè½»é‡çº§åº”ç”¨ã€‚ ç¼ºç‚¹ æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼š select() å—é™äº FD_SETSIZEï¼ˆé€šå¸¸ä¸º 1024ï¼‰ï¼Œæ— æ³•å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ã€‚ åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œselect() æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚ æ€§èƒ½é—®é¢˜ï¼š select() éœ€è¦çº¿æ€§æ‰«ææ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œåœ¨ç›‘è§†å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶æ•ˆç‡ä½ä¸‹ã€‚ æ¯æ¬¡è°ƒç”¨ select() éƒ½éœ€è¦é‡æ–°è®¾ç½® fd_setï¼Œå¢åŠ äº†ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ã€‚ ä¸æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼š select() ä»…æ”¯æŒæ°´å¹³è§¦å‘ï¼ˆLevel-Triggeredï¼‰ï¼Œæ— æ³•åƒ epoll æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼ˆEdge-Triggeredï¼‰é‚£æ ·é«˜æ•ˆå¤„ç†äº‹ä»¶ã€‚ å¯è¯»æ€§ä¸ç»´æŠ¤æ€§ï¼š éšç€ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦å¢å¤šï¼Œä»£ç çš„å¤æ‚æ€§å’Œå¯ç»´æŠ¤æ€§é™ä½ã€‚ äº”ã€select() çš„åº”ç”¨åœºæ™¯ å°½ç®¡ select() å­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œselect() ä»ç„¶æ˜¯ä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ï¼š\nä½å¹¶å‘è¿æ¥ï¼š å¯¹äºè¿æ¥æ•°è¾ƒå°‘çš„æœåŠ¡å™¨ï¼Œselect() å¯ä»¥æœ‰æ•ˆç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œæ— éœ€æ‹…å¿ƒæ€§èƒ½é—®é¢˜ã€‚ è·¨å¹³å°åº”ç”¨ï¼š éœ€è¦åœ¨ä¸åŒæ“ä½œç³»ç»Ÿé—´ç§»æ¤çš„åº”ç”¨ï¼Œselect() çš„å¹¿æ³›æ”¯æŒä½¿å…¶æˆä¸ºé¦–é€‰ã€‚ ç®€å•çš„ I/O å¤šè·¯å¤ç”¨éœ€æ±‚ï¼š åœ¨éœ€è¦ç®€å•å®ç° I/O å¤šè·¯å¤ç”¨åŠŸèƒ½ä½†ä¸éœ€è¦å¤„ç†å¤§é‡å¹¶å‘è¿æ¥çš„æƒ…å†µä¸‹ï¼Œselect() æ˜¯ä¸€ç§ä¾¿æ·çš„é€‰æ‹©ã€‚ åµŒå…¥å¼ç³»ç»Ÿï¼š èµ„æºæœ‰é™çš„åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œselect() çš„è½»é‡çº§ç‰¹æ€§ä½¿å…¶é€‚ç”¨äºç®€å•çš„ç½‘ç»œé€šä¿¡ä»»åŠ¡ã€‚ å…­ã€select() çš„æ›¿ä»£æ–¹æ¡ˆ éšç€ç½‘ç»œåº”ç”¨çš„å‘å±•ï¼Œå‡ºç°äº†å¤šç§æ›¿ä»£ select() çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä»¥å…‹æœå…¶ä¸è¶³ã€‚è¿™äº›æ›¿ä»£æ–¹æ¡ˆåœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥å’Œæå‡æ€§èƒ½æ–¹é¢å…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ã€‚\n6.1 poll() poll() æ˜¯ select() çš„ç›´æ¥æ›¿ä»£å“ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\næ–‡ä»¶æè¿°ç¬¦æ•°é‡ä¸å—é™åˆ¶ï¼šä¸åƒ select() æœ‰ FD_SETSIZE çš„é™åˆ¶ï¼Œpoll() å¯ä»¥å¤„ç†æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ æ›´ç®€æ´çš„æ¥å£ï¼šä½¿ç”¨æ•°ç»„æ¥ç®¡ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…äº† FD_SET ç­‰å®çš„å¤æ‚æ€§ã€‚ 6.2 epollï¼ˆLinux ç‰¹æœ‰ï¼‰ epoll æ˜¯ Linux æä¾›çš„ä¸€ç§é«˜æ•ˆçš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š\né«˜æ€§èƒ½ï¼šepoll é‡‡ç”¨äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œé€‚åˆå¤„ç†å¤§è§„æ¨¡å¹¶å‘è¿æ¥ã€‚ æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼šç›¸æ¯” select() ä»…æ”¯æŒæ°´å¹³è§¦å‘ï¼Œepoll æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼Œå‡å°‘ä¸å¿…è¦çš„äº‹ä»¶é€šçŸ¥ã€‚ å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å…±äº«äº‹ä»¶è¡¨ï¼šé¿å…äº†æ¯æ¬¡è°ƒç”¨ epoll_wait() æ—¶éƒ½éœ€è¦é‡æ–°ä¼ é€’å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæé«˜æ•ˆç‡ã€‚ 6.3 kqueueï¼ˆBSD ç³»ç»Ÿç‰¹æœ‰ï¼‰ kqueue æ˜¯ BSD ç³»ç»Ÿï¼ˆå¦‚ FreeBSDã€macOSï¼‰æä¾›çš„ä¸€ç§é«˜æ•ˆçš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\né«˜æ•ˆçš„äº‹ä»¶å¤„ç†ï¼šç±»ä¼¼äº epollï¼Œkqueue æä¾›é«˜æ•ˆçš„äº‹ä»¶é€šçŸ¥å’Œç®¡ç†ã€‚ çµæ´»çš„äº‹ä»¶è¿‡æ»¤ï¼šæ”¯æŒå¤šç§ç±»å‹çš„äº‹ä»¶è¿‡æ»¤ï¼Œå¦‚æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶ã€ä¿¡å·äº‹ä»¶ç­‰ã€‚ 6.4 å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å‹ é™¤äº†åŸºäº I/O å¤šè·¯å¤ç”¨çš„æ–¹æ¡ˆï¼Œå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹æ¨¡å‹ä¹Ÿæ˜¯å¤„ç†å¹¶å‘è¿æ¥çš„å¸¸è§æ–¹æ³•ï¼š\nå¤šçº¿ç¨‹ï¼š æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥ç”±ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å¤„ç†ï¼Œé€‚ç”¨äºè¿æ¥æ•°è¾ƒå°‘çš„åœºæ™¯ã€‚ éœ€è¦å¤„ç†çº¿ç¨‹åŒæ­¥å’Œèµ„æºå…±äº«é—®é¢˜ã€‚ å¤šè¿›ç¨‹ï¼š ä½¿ç”¨ fork() ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œé€‚ç”¨äºéœ€è¦éš”ç¦»ä¸åŒå®¢æˆ·ç«¯çš„åœºæ™¯ã€‚ è¿›ç¨‹é—´èµ„æºæ¶ˆè€—è¾ƒé«˜ï¼Œç®¡ç†å¤æ‚ã€‚ 6.5 å¼‚æ­¥ I/O ç°ä»£ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ï¼ˆå¦‚ C++ çš„ Boost.Asioã€Python çš„ asyncioï¼‰æä¾›äº†å¼‚æ­¥ I/O æ”¯æŒï¼Œç»“åˆäº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œå¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¿æ¥ã€‚\n",
  "wordCount" : "4354",
  "inLanguage": "zh",
  "datePublished": "2024-03-19T20:19:02+08:00",
  "dateModified": "2024-03-19T20:19:02+08:00",
  "author":[{
    "@type": "Person",
    "name": "å²ç‰æµ©"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://oheyu.github.io/zh/posts/tech/linux%E7%9A%84io%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "å²ç‰æµ©çš„ä¸ªäººåšå®¢",
    "logo": {
      "@type": "ImageObject",
      "url": "https://oheyu.github.io/img/logo.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://oheyu.github.io/zh/" accesskey="h" title="å²ç‰æµ©çš„ä¸ªäººåšå®¢ (Alt + H)">å²ç‰æµ©çš„ä¸ªäººåšå®¢</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://oheyu.github.io/en/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://oheyu.github.io/zh/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/archives" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/categories" title="ğŸ§©åˆ†ç±»">
                    <span>ğŸ§©åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://oheyu.github.io/zh/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://oheyu.github.io/zh/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://oheyu.github.io/zh/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title entry-hint-parent">
      Linuxçš„IOå¤ç”¨ä¹‹select
    </h1>
    <div class="post-meta"><span title='2024-03-19 20:19:02 +0800 CST'>2024-03-19</span>&nbsp;Â·&nbsp;9 åˆ†é’Ÿ&nbsp;Â·&nbsp;å²ç‰æµ©

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e4%b8%80%e4%bb%80%e4%b9%88%e6%98%af-select-%e5%87%bd%e6%95%b0" aria-label="ä¸€ã€ä»€ä¹ˆæ˜¯ select() å‡½æ•°ï¼Ÿ">ä¸€ã€ä»€ä¹ˆæ˜¯ <code>select()</code> å‡½æ•°ï¼Ÿ</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="è¿”å›å€¼">è¿”å›å€¼</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%8cselect-%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="äºŒã€select() çš„å·¥ä½œåŸç†">äºŒã€<code>select()</code> çš„å·¥ä½œåŸç†</a></li>
                    <li>
                        <a href="#%e4%b8%89select-%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="ä¸‰ã€select() çš„ä½¿ç”¨æ–¹æ³•">ä¸‰ã€<code>select()</code> çš„ä½¿ç”¨æ–¹æ³•</a><ul>
                            
                    <li>
                        <a href="#31-%e5%85%b3%e9%94%ae%e7%82%b9%e8%a7%a3%e6%9e%90" aria-label="3.1 å…³é”®ç‚¹è§£æ">3.1 å…³é”®ç‚¹è§£æ</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%a4%8d%e5%88%b6-readfds-%e7%bb%99-tmpfds" aria-label="ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶ readfds ç»™ tmpfds">ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶ <code>readfds</code> ç»™ <code>tmpfds</code></a></li>
                    <li>
                        <a href="#%e7%bb%b4%e6%8a%a4-maxfd" aria-label="ç»´æŠ¤ maxfd">ç»´æŠ¤ <code>maxfd</code></a></li>
                    <li>
                        <a href="#%e8%b6%85%e6%97%b6%e5%a4%84%e7%90%86" aria-label="è¶…æ—¶å¤„ç†">è¶…æ—¶å¤„ç†</a></li>
                    <li>
                        <a href="#%e7%bc%93%e5%86%b2%e5%8c%ba%e5%ae%89%e5%85%a8" aria-label="ç¼“å†²åŒºå®‰å…¨">ç¼“å†²åŒºå®‰å…¨</a></li>
                    <li>
                        <a href="#%e9%94%99%e8%af%af%e5%a4%84%e7%90%86" aria-label="é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%9b%9bselect-%e7%9a%84%e4%bc%98%e7%bc%ba%e7%82%b9" aria-label="å››ã€select() çš„ä¼˜ç¼ºç‚¹">å››ã€<code>select()</code> çš„ä¼˜ç¼ºç‚¹</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e4%bc%98%e7%82%b9" aria-label="ä¼˜ç‚¹">ä¼˜ç‚¹</a></li>
                    <li>
                        <a href="#%e7%bc%ba%e7%82%b9" aria-label="ç¼ºç‚¹">ç¼ºç‚¹</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%94select-%e7%9a%84%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af" aria-label="äº”ã€select() çš„åº”ç”¨åœºæ™¯">äº”ã€<code>select()</code> çš„åº”ç”¨åœºæ™¯</a></li>
                    <li>
                        <a href="#%e5%85%adselect-%e7%9a%84%e6%9b%bf%e4%bb%a3%e6%96%b9%e6%a1%88" aria-label="å…­ã€select() çš„æ›¿ä»£æ–¹æ¡ˆ">å…­ã€<code>select()</code> çš„æ›¿ä»£æ–¹æ¡ˆ</a><ul>
                            
                    <li>
                        <a href="#61-poll" aria-label="6.1 poll()">6.1 <code>poll()</code></a></li>
                    <li>
                        <a href="#62-epolllinux-%e7%89%b9%e6%9c%89" aria-label="6.2 epollï¼ˆLinux ç‰¹æœ‰ï¼‰">6.2 <code>epoll</code>ï¼ˆLinux ç‰¹æœ‰ï¼‰</a></li>
                    <li>
                        <a href="#63-kqueuebsd-%e7%b3%bb%e7%bb%9f%e7%89%b9%e6%9c%89" aria-label="6.3 kqueueï¼ˆBSD ç³»ç»Ÿç‰¹æœ‰ï¼‰">6.3 <code>kqueue</code>ï¼ˆBSD ç³»ç»Ÿç‰¹æœ‰ï¼‰</a></li>
                    <li>
                        <a href="#64-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%a4%9a%e8%bf%9b%e7%a8%8b%e6%a8%a1%e5%9e%8b" aria-label="6.4 å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å‹">6.4 å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å‹</a></li>
                    <li>
                        <a href="#65-%e5%bc%82%e6%ad%a5-io" aria-label="6.5 å¼‚æ­¥ I/O">6.5 å¼‚æ­¥ I/O</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
  <div class="post-content"><!-- more -->
<p><code>select()</code> å‡½æ•°ä½œä¸ºä¸€ç§ç»å…¸çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚å¥—æ¥å­—ï¼‰æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚è™½ç„¶å·²ç»è¿‡æ—¶ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿›ä¸€æ­¥äº†è§£å…¶ä»–å¤ç”¨æœ‰æå¤§çš„å¸®åŠ©ã€‚</p>
<hr>
<h2 id="ä¸€ä»€ä¹ˆæ˜¯-select-å‡½æ•°">ä¸€ã€ä»€ä¹ˆæ˜¯ <code>select()</code> å‡½æ•°ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#ä¸€ä»€ä¹ˆæ˜¯-select-å‡½æ•°">#</a></h2>
<p><code>select()</code> æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½äº POSIX æ ‡å‡†ä¸­ï¼Œä¸»è¦ç”¨äºç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥æ£€æµ‹å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œï¼ˆå¦‚è¯»ã€å†™æˆ–å‘ç”Ÿå¼‚å¸¸ï¼‰ã€‚å®ƒå…è®¸ç¨‹åºåœ¨å•ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä¸­åŒæ—¶å¤„ç†å¤šä¸ª I/O äº‹ä»¶ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„èµ„æºåˆ©ç”¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/select.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">select</span><span class="p">(</span><span class="kt">int</span> <span class="n">nfds</span><span class="p">,</span> <span class="n">fd_set</span> <span class="o">*</span><span class="n">readfds</span><span class="p">,</span> <span class="n">fd_set</span> <span class="o">*</span><span class="n">writefds</span><span class="p">,</span> <span class="n">fd_set</span> <span class="o">*</span><span class="n">exceptfds</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>nfds</code></strong>ï¼šéœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„å€¼åŠ ä¸€ã€‚</li>
<li><strong><code>readfds</code></strong>ï¼šæŒ‡å‘ <code>fd_set</code> ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºç›‘è§†å¯è¯»äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚</li>
<li><strong><code>writefds</code></strong>ï¼šæŒ‡å‘ <code>fd_set</code> ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºç›‘è§†å¯å†™äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚</li>
<li><strong><code>exceptfds</code></strong>ï¼šæŒ‡å‘ <code>fd_set</code> ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºç›‘è§†å¼‚å¸¸äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚</li>
<li><strong><code>timeout</code></strong>ï¼šæŒ‡å‘ <code>timeval</code> ç»“æ„çš„æŒ‡é’ˆï¼ŒæŒ‡å®š <code>select()</code> å‡½æ•°çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœä¸º <code>NULL</code>ï¼Œ<code>select()</code> ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚</li>
</ul>
<h4 id="è¿”å›å€¼">è¿”å›å€¼<a hidden class="anchor" aria-hidden="true" href="#è¿”å›å€¼">#</a></h4>
<ul>
<li><strong>æ­£æ•°</strong>ï¼šè¡¨ç¤ºå‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚</li>
<li><strong><code>0</code></strong>ï¼šè¡¨ç¤º <code>select()</code> è¶…æ—¶ï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿã€‚</li>
<li><strong><code>-1</code></strong>ï¼šè¡¨ç¤ºè°ƒç”¨å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯å­˜å‚¨åœ¨ <code>errno</code> ä¸­ã€‚</li>
</ul>
<hr>
<h2 id="äºŒselect-çš„å·¥ä½œåŸç†">äºŒã€<code>select()</code> çš„å·¥ä½œåŸç†<a hidden class="anchor" aria-hidden="true" href="#äºŒselect-çš„å·¥ä½œåŸç†">#</a></h2>
<p><code>select()</code> çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ˆ<code>fd_set</code>ï¼‰æ¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å˜åŒ–ã€‚å®ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤å·¥ä½œï¼š</p>
<ol>
<li><strong>åˆå§‹åŒ–æ–‡ä»¶æè¿°ç¬¦é›†åˆ</strong>ï¼šä½¿ç”¨ <code>FD_ZERO</code> æ¸…ç©ºé›†åˆï¼Œä½¿ç”¨ <code>FD_SET</code> å°†éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥é›†åˆã€‚</li>
<li><strong>è°ƒç”¨ <code>select()</code></strong>ï¼šå°†å‡†å¤‡å¥½çš„ <code>fd_set</code> ä¼ é€’ç»™ <code>select()</code>ï¼Œå¹¶æŒ‡å®šç›‘è§†çš„äº‹ä»¶ç±»å‹ï¼ˆè¯»ã€å†™ã€å¼‚å¸¸ï¼‰ã€‚</li>
<li><strong>ç­‰å¾…äº‹ä»¶å‘ç”Ÿ</strong>ï¼š<code>select()</code> ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ–‡ä»¶æè¿°ç¬¦æ»¡è¶³æŒ‡å®šçš„äº‹ä»¶ï¼Œæˆ–è¶…æ—¶æ—¶é—´åˆ°è¾¾ã€‚</li>
<li><strong>å¤„ç†äº‹ä»¶</strong>ï¼š<code>select()</code> è¿”å›åï¼Œéå†æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä½¿ç”¨ <code>FD_ISSET</code> åˆ¤æ–­å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†äº‹ä»¶ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼š<code>select()</code> ä¼šä¿®æ”¹ä¼ å…¥çš„ <code>fd_set</code> é›†åˆï¼Œä»…ä¿ç•™å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ <code>select()</code> å‰ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–æˆ–å¤åˆ¶åŸå§‹çš„ <code>fd_set</code>ã€‚</p>
<hr>
<h2 id="ä¸‰select-çš„ä½¿ç”¨æ–¹æ³•">ä¸‰ã€<code>select()</code> çš„ä½¿ç”¨æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#ä¸‰select-çš„ä½¿ç”¨æ–¹æ³•">#</a></h2>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºäº <code>select()</code> çš„ç®€å• TCP æœåŠ¡å™¨ç¤ºä¾‹ï¼Œèƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶å›æ˜¾å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 1024
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">initserver</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;port&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socketã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">listensock</span> <span class="o">=</span> <span class="nf">initserver</span><span class="p">(</span><span class="nf">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">listensock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;initserver() failed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Listening on socket=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">listensock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fd_set</span> <span class="n">readfds</span><span class="p">;</span>                         
</span></span><span class="line"><span class="cl">    <span class="nf">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>                
</span></span><span class="line"><span class="cl">    <span class="nf">FD_SET</span><span class="p">(</span><span class="n">listensock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">maxfd</span> <span class="o">=</span> <span class="n">listensock</span><span class="p">;</span>              
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>        <span class="c1">// äº‹ä»¶å¾ªç¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">timeout</span><span class="p">;</span>     
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>        <span class="c1">// ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">timeout</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="c1">// å¾®ç§’ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">fd_set</span> <span class="n">tmpfds</span> <span class="o">=</span> <span class="n">readfds</span><span class="p">;</span>      <span class="c1">// å¤åˆ¶ readfdsï¼Œé¿å…è¢« select() ä¿®æ”¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨select() ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼ˆç›‘è§†å“ªäº›socketå‘ç”Ÿäº†äº‹ä»¶)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">infds</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="n">maxfd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpfds</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœinfds&lt;0ï¼Œè¡¨ç¤ºè°ƒç”¨select()å¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">infds</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è¢«ä¿¡å·ä¸­æ–­ï¼Œç»§ç»­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;select() failed&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœinfds==0ï¼Œè¡¨ç¤ºselect()è¶…æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">infds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;select() timeout.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœinfds&gt;0ï¼Œè¡¨ç¤ºæœ‰äº‹ä»¶å‘ç”Ÿï¼Œinfdså­˜æ”¾äº†å·²å‘ç”Ÿäº‹ä»¶çš„ä¸ªæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">eventfd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eventfd</span> <span class="o">&lt;=</span> <span class="n">maxfd</span> <span class="o">&amp;&amp;</span> <span class="n">infds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eventfd</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">FD_ISSET</span><span class="p">(</span><span class="n">eventfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpfds</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">infds</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// å¦‚æœå‘ç”Ÿäº‹ä»¶çš„æ˜¯listensockï¼Œè¡¨ç¤ºæœ‰æ–°çš„å®¢æˆ·ç«¯è¿ä¸Šæ¥äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">eventfd</span> <span class="o">==</span> <span class="n">listensock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">socklen_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">clientsock</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">listensock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">clientsock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                    <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept() failed&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Accepted client(socket=%d) from %s:%d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                           <span class="n">clientsock</span><span class="p">,</span> <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nf">FD_SET</span><span class="p">(</span><span class="n">clientsock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>                      <span class="c1">// æŠŠæ–°è¿ä¸Šæ¥çš„å®¢æˆ·ç«¯çš„æ ‡å¿—ä½ç½®ä¸º1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">clientsock</span> <span class="o">&gt;</span> <span class="n">maxfd</span><span class="p">)</span> <span class="n">maxfd</span> <span class="o">=</span> <span class="n">clientsock</span><span class="p">;</span>    <span class="c1">// æ›´æ–°maxfdçš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥çš„socketæœ‰äº‹ä»¶ï¼Œè¡¨ç¤ºæ¥æ”¶ç¼“å­˜ä¸­æœ‰æ•°æ®å¯ä»¥è¯»ï¼Œæˆ–è€…æœ‰å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ssize_t</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="nf">recv</span><span class="p">(</span><span class="n">eventfd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// å®¢æˆ·ç«¯å…³é—­è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Client(socket=%d) disconnected.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">eventfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;recv() failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">close</span><span class="p">(</span><span class="n">eventfd</span><span class="p">);</span>                         <span class="c1">// å…³é—­å®¢æˆ·ç«¯çš„socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                        <span class="nf">FD_CLR</span><span class="p">(</span><span class="n">eventfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>     <span class="c1">// æŠŠbitmapä¸­å·²å…³é—­å®¢æˆ·ç«¯çš„æ ‡å¿—ä½æ¸…ç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">eventfd</span> <span class="o">==</span> <span class="n">maxfd</span><span class="p">)</span>              <span class="c1">// é‡æ–°è®¡ç®—maxfdçš„å€¼ï¼Œåªæœ‰å½“eventfd==maxfdæ—¶æ‰éœ€è¦è®¡ç®—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">while</span> <span class="p">(</span><span class="nf">FD_ISSET</span><span class="p">(</span><span class="n">maxfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">maxfd</span> <span class="o">&gt;</span> <span class="n">listensock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">maxfd</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// å¦‚æœå®¢æˆ·ç«¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">buffer</span><span class="p">[</span><span class="n">bytes_received</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="c1">// ç¡®ä¿å­—ç¬¦ä¸²ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Received from socket=%d: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">eventfd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// æŠŠæ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹åŸå°ä¸åŠ¨çš„å‘å›å»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">ssize_t</span> <span class="n">bytes_sent</span> <span class="o">=</span> <span class="nf">send</span><span class="p">(</span><span class="n">eventfd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bytes_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">bytes_sent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;send() failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="nf">close</span><span class="p">(</span><span class="n">eventfd</span><span class="p">);</span>                         <span class="c1">// å…³é—­å®¢æˆ·ç«¯çš„socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="nf">FD_CLR</span><span class="p">(</span><span class="n">eventfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>     <span class="c1">// æŠŠbitmapä¸­å·²å…³é—­å®¢æˆ·ç«¯çš„æ ‡å¿—ä½æ¸…ç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(</span><span class="n">eventfd</span> <span class="o">==</span> <span class="n">maxfd</span><span class="p">)</span>              
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">while</span> <span class="p">(</span><span class="nf">FD_ISSET</span><span class="p">(</span><span class="n">maxfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">maxfd</span> <span class="o">&gt;</span> <span class="n">listensock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">maxfd</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Echoed back to socket=%d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">eventfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">listensock</span><span class="p">);</span> <span class="c1">// ç¨‹åºç»“æŸå‰å…³é—­ç›‘å¬socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">initserver</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket() failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setsockopt() failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="nf">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind() failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen() failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ä»£ç è¯¦è§£</strong></p>
<ol>
<li>
<p><strong>åˆå§‹åŒ–æœåŠ¡å™¨å¥—æ¥å­—</strong>ï¼š</p>
<ul>
<li><strong>åˆ›å»ºå¥—æ¥å­—</strong>ï¼šä½¿ç”¨ <code>socket(AF_INET, SOCK_STREAM, 0)</code> åˆ›å»ºä¸€ä¸ª TCP å¥—æ¥å­—ã€‚</li>
<li><strong>è®¾ç½®å¥—æ¥å­—é€‰é¡¹</strong>ï¼šé€šè¿‡ <code>setsockopt</code> è®¾ç½® <code>SO_REUSEADDR</code> é€‰é¡¹ï¼Œå…è®¸é‡ç”¨æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œé¿å…åœ¨æœåŠ¡å™¨é‡å¯åå‡ºç° <code>bind</code> å¤±è´¥çš„æƒ…å†µã€‚</li>
<li><strong>ç»‘å®šåœ°å€å’Œç«¯å£</strong>ï¼šå°†å¥—æ¥å­—ç»‘å®šåˆ°æŒ‡å®šç«¯å£å’Œæ‰€æœ‰å¯ç”¨æ¥å£ (<code>INADDR_ANY</code>)ã€‚</li>
<li><strong>ç›‘å¬</strong>ï¼šå°†å¥—æ¥å­—ç½®äºç›‘å¬çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>åˆå§‹åŒ– <code>fd_set</code> é›†åˆ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>FD_ZERO</code> æ¸…ç©º <code>readfds</code> é›†åˆã€‚</li>
<li>ä½¿ç”¨ <code>FD_SET</code> å°†ç›‘å¬å¥—æ¥å­—åŠ å…¥ <code>readfds</code> é›†åˆã€‚</li>
<li>ç»´æŠ¤ä¸€ä¸ªå˜é‡ <code>maxfd</code>ï¼Œè®°å½•å½“å‰ç›‘è§†çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼ï¼Œç”¨äº <code>select()</code> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</li>
</ul>
</li>
<li>
<p><strong>äº‹ä»¶å¾ªç¯</strong>ï¼š</p>
<ul>
<li><strong>è¶…æ—¶è®¾ç½®</strong>ï¼šå®šä¹‰ä¸€ä¸ª <code>timeval</code> ç»“æ„ä½“ï¼Œè®¾ç½® <code>select()</code> çš„è¶…æ—¶æ—¶é—´ä¸º 10 ç§’ã€‚</li>
<li><strong>å¤åˆ¶ <code>fd_set</code></strong>ï¼šæ¯æ¬¡è°ƒç”¨ <code>select()</code> å‰ï¼Œå°†åŸå§‹çš„ <code>readfds</code> é›†åˆå¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶çš„ <code>tmpfds</code> é›†åˆï¼Œå› ä¸º <code>select()</code> ä¼šä¿®æ”¹ä¼ å…¥çš„é›†åˆã€‚</li>
<li><strong>è°ƒç”¨ <code>select()</code></strong>ï¼šç›‘è§†è¯»äº‹ä»¶ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿæˆ–è¶…æ—¶ã€‚</li>
<li><strong>å¤„ç†äº‹ä»¶</strong>ï¼š
<ul>
<li><strong>æ–°è¿æ¥äº‹ä»¶</strong>ï¼šå¦‚æœç›‘å¬å¥—æ¥å­—æœ‰äº‹ä»¶ï¼Œè°ƒç”¨ <code>accept()</code> æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°†æ–°å®¢æˆ·ç«¯çš„å¥—æ¥å­—åŠ å…¥ <code>readfds</code> é›†åˆï¼Œå¹¶æ›´æ–° <code>maxfd</code>ã€‚</li>
<li><strong>æ•°æ®æ¥æ”¶äº‹ä»¶</strong>ï¼šå¦‚æœå·²æœ‰å®¢æˆ·ç«¯å¥—æ¥å­—æœ‰äº‹ä»¶ï¼Œè°ƒç”¨ <code>recv()</code> æ¥æ”¶æ•°æ®ã€‚å¦‚æœ <code>recv()</code> è¿”å›å€¼ &lt;= 0ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œå…³é—­å¥—æ¥å­—å¹¶ä» <code>readfds</code> ä¸­ç§»é™¤ï¼›å¦åˆ™ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®å›æ˜¾ç»™å®¢æˆ·ç«¯ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>èµ„æºç®¡ç†</strong>ï¼š</p>
<ul>
<li>åœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œå…³é—­ç›¸åº”çš„å¥—æ¥å­—å¹¶ä» <code>readfds</code> ä¸­ç§»é™¤ï¼Œé˜²æ­¢èµ„æºæ³„æ¼ã€‚</li>
<li>ç¨‹åºç»“æŸå‰ï¼Œå…³é—­ç›‘å¬å¥—æ¥å­—ï¼Œé‡Šæ”¾èµ„æºã€‚</li>
</ul>
</li>
</ol>
<h3 id="31-å…³é”®ç‚¹è§£æ">3.1 å…³é”®ç‚¹è§£æ<a hidden class="anchor" aria-hidden="true" href="#31-å…³é”®ç‚¹è§£æ">#</a></h3>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶-readfds-ç»™-tmpfds">ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶ <code>readfds</code> ç»™ <code>tmpfds</code><a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶-readfds-ç»™-tmpfds">#</a></h4>
<p><code>select()</code> å‡½æ•°ä¼šä¿®æ”¹ä¼ å…¥çš„ <code>fd_set</code> é›†åˆï¼Œä»…ä¿ç•™å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ <code>select()</code> å‰ï¼Œéœ€è¦å°†åŸå§‹çš„ <code>readfds</code> å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶é›†åˆ <code>tmpfds</code>ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­ä»èƒ½ç›‘è§†æ‰€æœ‰éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">fd_set</span> <span class="n">tmpfds</span> <span class="o">=</span> <span class="n">readfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">infds</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="n">maxfd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpfds</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦åˆ™ï¼Œå¦‚æœç›´æ¥ä¼ å…¥ <code>readfds</code>ï¼Œæ¯æ¬¡ <code>select()</code> è°ƒç”¨åï¼Œ<code>readfds</code> åªä¼šåŒ…å«å‘ç”Ÿäº†äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ— æ³•ç»§ç»­ç›‘è§†å…¶ä»–å¥—æ¥å­—ã€‚</p>
<h4 id="ç»´æŠ¤-maxfd">ç»´æŠ¤ <code>maxfd</code><a hidden class="anchor" aria-hidden="true" href="#ç»´æŠ¤-maxfd">#</a></h4>
<p><code>select()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>nfds</code> éœ€è¦è®¾ç½®ä¸ºæ‰€æœ‰ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ä¸­æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦å€¼åŠ ä¸€ã€‚å› æ­¤ï¼Œæ¯æ¬¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œéœ€è¦æ›´æ–° <code>maxfd</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">clientsock</span> <span class="o">&gt;</span> <span class="n">maxfd</span><span class="p">)</span> <span class="n">maxfd</span> <span class="o">=</span> <span class="n">clientsock</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“æœ‰å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¸”è¯¥å¥—æ¥å­—æ˜¯å½“å‰ <code>maxfd</code> æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ–°çš„ <code>maxfd</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">eventfd</span> <span class="o">==</span> <span class="n">maxfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nf">FD_ISSET</span><span class="p">(</span><span class="n">maxfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">maxfd</span> <span class="o">&gt;</span> <span class="n">listensock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">maxfd</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è¶…æ—¶å¤„ç†">è¶…æ—¶å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#è¶…æ—¶å¤„ç†">#</a></h4>
<p>åœ¨åŸå§‹ä»£ç ä¸­ï¼Œè™½ç„¶å®šä¹‰äº† <code>timeout</code>ï¼Œä½†ä¼ å…¥ <code>select()</code> çš„å‚æ•°æ˜¯ <code>0</code>ï¼Œè¡¨ç¤ºæ— é™ç­‰å¾…ã€‚æ­£ç¡®çš„åšæ³•æ˜¯å°† <code>&amp;timeout</code> ä¼ å…¥ <code>select()</code>ï¼Œä»¥å®ç°è¶…æ—¶æœºåˆ¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">infds</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="n">maxfd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpfds</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œå½“è¶…è¿‡ 10 ç§’æ²¡æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>select()</code> ä¼šè¿”å› <code>0</code>ï¼Œç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œå¦‚æ‰“å°è¶…æ—¶ä¿¡æ¯ã€‚</p>
<h4 id="ç¼“å†²åŒºå®‰å…¨">ç¼“å†²åŒºå®‰å…¨<a hidden class="anchor" aria-hidden="true" href="#ç¼“å†²åŒºå®‰å…¨">#</a></h4>
<p>åœ¨æ¥æ”¶æ•°æ®åï¼Œæ‰‹åŠ¨æ·»åŠ  null å­—ç¬¦ï¼Œç¡®ä¿å­—ç¬¦ä¸²å®‰å…¨ï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">buffer</span><span class="p">[</span><span class="n">bytes_received</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="c1">// ç¡®ä¿å­—ç¬¦ä¸²ç»ˆæ­¢
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ—¶ï¼Œ<code>recv()</code> è°ƒç”¨ä¸­ï¼Œä½¿ç”¨ <code>sizeof(buffer) - 1</code> ä½œä¸ºæ¥æ”¶é•¿åº¦ï¼Œç•™å‡ºä¸€ä¸ªå­—èŠ‚ç”¨äºå­˜å‚¨ null å­—ç¬¦ã€‚</p>
<h4 id="é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#é”™è¯¯å¤„ç†">#</a></h4>
<p>åœ¨å¥—æ¥å­—æ“ä½œä¸­ï¼Œåˆç†å¤„ç†é”™è¯¯æƒ…å†µï¼Œå¦‚ <code>accept()</code>ã€<code>recv()</code>ã€<code>send()</code> å¤±è´¥æ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é‡‡å–ç›¸åº”çš„æªæ–½ï¼ˆå¦‚å…³é—­å¥—æ¥å­—ã€ç§»é™¤é›†åˆç­‰ï¼‰ï¼Œç¡®ä¿ç¨‹åºçš„å¥å£®æ€§ã€‚</p>
<hr>
<h2 id="å››select-çš„ä¼˜ç¼ºç‚¹">å››ã€<code>select()</code> çš„ä¼˜ç¼ºç‚¹<a hidden class="anchor" aria-hidden="true" href="#å››select-çš„ä¼˜ç¼ºç‚¹">#</a></h2>
<h4 id="ä¼˜ç‚¹">ä¼˜ç‚¹<a hidden class="anchor" aria-hidden="true" href="#ä¼˜ç‚¹">#</a></h4>
<ol>
<li><strong>ç®€å•æ˜“ç”¨</strong>ï¼š<code>select()</code> æ˜¯ä¸€ç§ç›¸å¯¹ç®€å•çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæ˜“äºç†è§£å’Œå®ç°ã€‚</li>
<li><strong>è·¨å¹³å°æ”¯æŒ</strong>ï¼š<code>select()</code> åœ¨å¤§å¤šæ•° POSIX ç³»ç»Ÿï¼ˆå¦‚ Linuxã€BSDã€macOSï¼‰å’Œ Windows å¹³å°ä¸Šéƒ½æœ‰å®ç°ï¼Œå…·æœ‰è‰¯å¥½çš„è·¨å¹³å°å…¼å®¹æ€§ã€‚</li>
<li><strong>æ— éœ€é¢å¤–åº“</strong>ï¼šä½¿ç”¨ <code>select()</code> ä¸éœ€è¦ä¾èµ–é¢å¤–çš„åº“ï¼Œé€‚ç”¨äºè½»é‡çº§åº”ç”¨ã€‚</li>
</ol>
<h4 id="ç¼ºç‚¹">ç¼ºç‚¹<a hidden class="anchor" aria-hidden="true" href="#ç¼ºç‚¹">#</a></h4>
<ol>
<li><strong>æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶</strong>ï¼š
<ul>
<li><code>select()</code> å—é™äº <code>FD_SETSIZE</code>ï¼ˆé€šå¸¸ä¸º 1024ï¼‰ï¼Œæ— æ³•å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ã€‚</li>
<li>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œ<code>select()</code> æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚</li>
</ul>
</li>
<li><strong>æ€§èƒ½é—®é¢˜</strong>ï¼š
<ul>
<li><code>select()</code> éœ€è¦çº¿æ€§æ‰«ææ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œåœ¨ç›‘è§†å¤§é‡æ–‡ä»¶æè¿°ç¬¦æ—¶æ•ˆç‡ä½ä¸‹ã€‚</li>
<li>æ¯æ¬¡è°ƒç”¨ <code>select()</code> éƒ½éœ€è¦é‡æ–°è®¾ç½® <code>fd_set</code>ï¼Œå¢åŠ äº†ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ã€‚</li>
</ul>
</li>
<li><strong>ä¸æ”¯æŒè¾¹ç¼˜è§¦å‘</strong>ï¼š
<ul>
<li><code>select()</code> ä»…æ”¯æŒæ°´å¹³è§¦å‘ï¼ˆLevel-Triggeredï¼‰ï¼Œæ— æ³•åƒ <code>epoll</code> æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼ˆEdge-Triggeredï¼‰é‚£æ ·é«˜æ•ˆå¤„ç†äº‹ä»¶ã€‚</li>
</ul>
</li>
<li><strong>å¯è¯»æ€§ä¸ç»´æŠ¤æ€§</strong>ï¼š
<ul>
<li>éšç€ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦å¢å¤šï¼Œä»£ç çš„å¤æ‚æ€§å’Œå¯ç»´æŠ¤æ€§é™ä½ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h2 id="äº”select-çš„åº”ç”¨åœºæ™¯">äº”ã€<code>select()</code> çš„åº”ç”¨åœºæ™¯<a hidden class="anchor" aria-hidden="true" href="#äº”select-çš„åº”ç”¨åœºæ™¯">#</a></h2>
<p>å°½ç®¡ <code>select()</code> å­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ<code>select()</code> ä»ç„¶æ˜¯ä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ï¼š</p>
<ol>
<li><strong>ä½å¹¶å‘è¿æ¥</strong>ï¼š
<ul>
<li>å¯¹äºè¿æ¥æ•°è¾ƒå°‘çš„æœåŠ¡å™¨ï¼Œ<code>select()</code> å¯ä»¥æœ‰æ•ˆç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œæ— éœ€æ‹…å¿ƒæ€§èƒ½é—®é¢˜ã€‚</li>
</ul>
</li>
<li><strong>è·¨å¹³å°åº”ç”¨</strong>ï¼š
<ul>
<li>éœ€è¦åœ¨ä¸åŒæ“ä½œç³»ç»Ÿé—´ç§»æ¤çš„åº”ç”¨ï¼Œ<code>select()</code> çš„å¹¿æ³›æ”¯æŒä½¿å…¶æˆä¸ºé¦–é€‰ã€‚</li>
</ul>
</li>
<li><strong>ç®€å•çš„ I/O å¤šè·¯å¤ç”¨éœ€æ±‚</strong>ï¼š
<ul>
<li>åœ¨éœ€è¦ç®€å•å®ç° I/O å¤šè·¯å¤ç”¨åŠŸèƒ½ä½†ä¸éœ€è¦å¤„ç†å¤§é‡å¹¶å‘è¿æ¥çš„æƒ…å†µä¸‹ï¼Œ<code>select()</code> æ˜¯ä¸€ç§ä¾¿æ·çš„é€‰æ‹©ã€‚</li>
</ul>
</li>
<li><strong>åµŒå…¥å¼ç³»ç»Ÿ</strong>ï¼š
<ul>
<li>èµ„æºæœ‰é™çš„åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œ<code>select()</code> çš„è½»é‡çº§ç‰¹æ€§ä½¿å…¶é€‚ç”¨äºç®€å•çš„ç½‘ç»œé€šä¿¡ä»»åŠ¡ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h2 id="å…­select-çš„æ›¿ä»£æ–¹æ¡ˆ">å…­ã€<code>select()</code> çš„æ›¿ä»£æ–¹æ¡ˆ<a hidden class="anchor" aria-hidden="true" href="#å…­select-çš„æ›¿ä»£æ–¹æ¡ˆ">#</a></h2>
<p>éšç€ç½‘ç»œåº”ç”¨çš„å‘å±•ï¼Œå‡ºç°äº†å¤šç§æ›¿ä»£ <code>select()</code> çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä»¥å…‹æœå…¶ä¸è¶³ã€‚è¿™äº›æ›¿ä»£æ–¹æ¡ˆåœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥å’Œæå‡æ€§èƒ½æ–¹é¢å…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ã€‚</p>
<h3 id="61-poll">6.1 <code>poll()</code><a hidden class="anchor" aria-hidden="true" href="#61-poll">#</a></h3>
<p><code>poll()</code> æ˜¯ <code>select()</code> çš„ç›´æ¥æ›¿ä»£å“ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>æ–‡ä»¶æè¿°ç¬¦æ•°é‡ä¸å—é™åˆ¶</strong>ï¼šä¸åƒ <code>select()</code> æœ‰ <code>FD_SETSIZE</code> çš„é™åˆ¶ï¼Œ<code>poll()</code> å¯ä»¥å¤„ç†æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li><strong>æ›´ç®€æ´çš„æ¥å£</strong>ï¼šä½¿ç”¨æ•°ç»„æ¥ç®¡ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…äº† <code>FD_SET</code> ç­‰å®çš„å¤æ‚æ€§ã€‚</li>
</ul>
<h3 id="62-epolllinux-ç‰¹æœ‰">6.2 <code>epoll</code>ï¼ˆLinux ç‰¹æœ‰ï¼‰<a hidden class="anchor" aria-hidden="true" href="#62-epolllinux-ç‰¹æœ‰">#</a></h3>
<p><code>epoll</code> æ˜¯ Linux æä¾›çš„ä¸€ç§é«˜æ•ˆçš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li><strong>é«˜æ€§èƒ½</strong>ï¼š<code>epoll</code> é‡‡ç”¨äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œé€‚åˆå¤„ç†å¤§è§„æ¨¡å¹¶å‘è¿æ¥ã€‚</li>
<li><strong>æ”¯æŒè¾¹ç¼˜è§¦å‘</strong>ï¼šç›¸æ¯” <code>select()</code> ä»…æ”¯æŒæ°´å¹³è§¦å‘ï¼Œ<code>epoll</code> æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼Œå‡å°‘ä¸å¿…è¦çš„äº‹ä»¶é€šçŸ¥ã€‚</li>
<li><strong>å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å…±äº«äº‹ä»¶è¡¨</strong>ï¼šé¿å…äº†æ¯æ¬¡è°ƒç”¨ <code>epoll_wait()</code> æ—¶éƒ½éœ€è¦é‡æ–°ä¼ é€’å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæé«˜æ•ˆç‡ã€‚</li>
</ul>
<h3 id="63-kqueuebsd-ç³»ç»Ÿç‰¹æœ‰">6.3 <code>kqueue</code>ï¼ˆBSD ç³»ç»Ÿç‰¹æœ‰ï¼‰<a hidden class="anchor" aria-hidden="true" href="#63-kqueuebsd-ç³»ç»Ÿç‰¹æœ‰">#</a></h3>
<p><code>kqueue</code> æ˜¯ BSD ç³»ç»Ÿï¼ˆå¦‚ FreeBSDã€macOSï¼‰æä¾›çš„ä¸€ç§é«˜æ•ˆçš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>é«˜æ•ˆçš„äº‹ä»¶å¤„ç†</strong>ï¼šç±»ä¼¼äº <code>epoll</code>ï¼Œ<code>kqueue</code> æä¾›é«˜æ•ˆçš„äº‹ä»¶é€šçŸ¥å’Œç®¡ç†ã€‚</li>
<li><strong>çµæ´»çš„äº‹ä»¶è¿‡æ»¤</strong>ï¼šæ”¯æŒå¤šç§ç±»å‹çš„äº‹ä»¶è¿‡æ»¤ï¼Œå¦‚æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶ã€ä¿¡å·äº‹ä»¶ç­‰ã€‚</li>
</ul>
<h3 id="64-å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ¨¡å‹">6.4 å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#64-å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ¨¡å‹">#</a></h3>
<p>é™¤äº†åŸºäº I/O å¤šè·¯å¤ç”¨çš„æ–¹æ¡ˆï¼Œå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹æ¨¡å‹ä¹Ÿæ˜¯å¤„ç†å¹¶å‘è¿æ¥çš„å¸¸è§æ–¹æ³•ï¼š</p>
<ul>
<li><strong>å¤šçº¿ç¨‹</strong>ï¼š
<ul>
<li>æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥ç”±ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å¤„ç†ï¼Œé€‚ç”¨äºè¿æ¥æ•°è¾ƒå°‘çš„åœºæ™¯ã€‚</li>
<li>éœ€è¦å¤„ç†çº¿ç¨‹åŒæ­¥å’Œèµ„æºå…±äº«é—®é¢˜ã€‚</li>
</ul>
</li>
<li><strong>å¤šè¿›ç¨‹</strong>ï¼š
<ul>
<li>ä½¿ç”¨ <code>fork()</code> ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œé€‚ç”¨äºéœ€è¦éš”ç¦»ä¸åŒå®¢æˆ·ç«¯çš„åœºæ™¯ã€‚</li>
<li>è¿›ç¨‹é—´èµ„æºæ¶ˆè€—è¾ƒé«˜ï¼Œç®¡ç†å¤æ‚ã€‚</li>
</ul>
</li>
</ul>
<h3 id="65-å¼‚æ­¥-io">6.5 å¼‚æ­¥ I/O<a hidden class="anchor" aria-hidden="true" href="#65-å¼‚æ­¥-io">#</a></h3>
<p>ç°ä»£ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ï¼ˆå¦‚ C++ çš„ Boost.Asioã€Python çš„ asyncioï¼‰æä¾›äº†å¼‚æ­¥ I/O æ”¯æŒï¼Œç»“åˆäº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œå¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¿æ¥ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://oheyu.github.io/zh/tags/linux/">Linux</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://oheyu.github.io/zh/posts/tech/memcpy%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>memcpy()å‡½æ•°è¯¦è§£</span>
  </a>
  <a class="next" href="https://oheyu.github.io/zh/posts/tech/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E4%B8%AD%E7%9A%84%E8%AF%BB%E4%BA%8B%E4%BB%B6%E4%B8%8E%E5%86%99%E4%BA%8B%E4%BB%B6/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ç½‘ç»œé€šä¿¡ä¸­çš„è¯»äº‹ä»¶ä¸å†™äº‹ä»¶</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://oheyu.github.io/zh/">å²ç‰æµ©çš„ä¸ªäººåšå®¢</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
