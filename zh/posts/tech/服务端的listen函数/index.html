<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>服务端的listen函数 | 史玉浩的个人博客</title>
<meta name="keywords" content="Linux">
<meta name="description" content="listen() 函数在网络编程中是服务器端建立连接的关键步骤。它将套接字设置为被动监听模式，等待客户端的连接请求。本文将深入剖析 listen() 函数，从其定义、参数、返">
<meta name="author" content="史玉浩">
<link rel="canonical" href="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84listen%E5%87%BD%E6%95%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9c78afd72529c14d4d3c0fa583c3e82265e0d8a303d475223d3b37442260ba22.css" integrity="sha256-nHiv1yUpwU1NPA&#43;lg8PoImXg2KMD1HUiPTs3RCJguiI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://oheyu.github.io/img/logo.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://oheyu.github.io/img/logo.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://oheyu.github.io/img/logo.svg">
<link rel="apple-touch-icon" href="https://oheyu.github.io/logo.svg">
<link rel="mask-icon" href="https://oheyu.github.io/logo.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84listen%E5%87%BD%E6%95%B0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

  

<meta property="og:title" content="服务端的listen函数" />
<meta property="og:description" content="listen() 函数在网络编程中是服务器端建立连接的关键步骤。它将套接字设置为被动监听模式，等待客户端的连接请求。本文将深入剖析 listen() 函数，从其定义、参数、返" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84listen%E5%87%BD%E6%95%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T10:13:49+08:00" />
<meta property="article:modified_time" content="2024-01-04T10:13:49+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="服务端的listen函数"/>
<meta name="twitter:description" content="listen() 函数在网络编程中是服务器端建立连接的关键步骤。它将套接字设置为被动监听模式，等待客户端的连接请求。本文将深入剖析 listen() 函数，从其定义、参数、返"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚 文章",
      "item": "https://oheyu.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "👨🏻‍💻 技术",
      "item": "https://oheyu.github.io/zh/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "服务端的listen函数",
      "item": "https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84listen%E5%87%BD%E6%95%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "服务端的listen函数",
  "name": "服务端的listen函数",
  "description": "listen() 函数在网络编程中是服务器端建立连接的关键步骤。它将套接字设置为被动监听模式，等待客户端的连接请求。本文将深入剖析 listen() 函数，从其定义、参数、返",
  "keywords": [
    "Linux"
  ],
  "articleBody": "\rlisten() 函数在网络编程中是服务器端建立连接的关键步骤。它将套接字设置为被动监听模式，等待客户端的连接请求。本文将深入剖析 listen() 函数，从其定义、参数、返回值，到工作原理、使用示例和常见问题。\n一、listen() 函数概述 1.1 定义与作用 listen() 函数用于将一个绑定（bind()）了地址和端口的套接字设置为 被动监听模式。这意味着套接字将准备接受客户端的连接请求，是构建服务器程序的重要一步。\n1.2 函数原型 1 2 3 4 #include #include int listen(int sockfd, int backlog); 二、listen() 函数的参数与返回值 2.1 参数解析 sockfd：套接字文件描述符，由 socket() 函数创建并返回，并已通过 bind() 绑定了本地地址和端口。 backlog：未完成连接队列的最大长度，即内核允许在监听套接字上排队的未处理连接的数量。 2.2 返回值 成功：返回 0，表示套接字已成功进入监听状态。 失败：返回 -1，并设置 errno，指示具体的错误原因。 三、listen() 函数的工作原理 3.1 连接队列的概念 在服务器端，TCP 协议使用两个队列来管理连接：\n未完成连接队列：存放已收到客户端的 SYN 请求，但服务器尚未发送 ACK 的连接（半连接）。 已完成连接队列：存放已完成三次握手的连接，等待 accept() 函数处理。 backlog 参数影响的是已完成连接队列的大小。\n3.2 套接字状态的转换 调用 listen() 后，套接字从主动模式（默认）转换为被动模式，准备接受连接请求。此时，套接字可以接收来自客户端的 SYN 包，并按照 TCP 的三次握手流程建立连接。\n四、listen() 的使用示例 4.1 服务器端监听示例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #include #include #include #include #include #define PORT 8080 #define BACKLOG 5 int main() { int server_fd; struct sockaddr_in address; int opt = 1; int addrlen = sizeof(address); // 创建套接字 if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) { perror(\"socket failed\"); return -1; } // 设置端口重用 if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, \u0026opt, sizeof(opt))) { perror(\"setsockopt failed\"); close(server_fd); return -1; } // 绑定地址 address.sin_family = AF_INET; address.sin_addr.s_addr = INADDR_ANY; address.sin_port = htons(PORT); if (bind(server_fd, (struct sockaddr *)\u0026address, sizeof(address)) \u003c 0) { perror(\"bind failed\"); close(server_fd); return -1; } // 开始监听 if (listen(server_fd, BACKLOG) \u003c 0) { perror(\"listen failed\"); close(server_fd); return -1; } printf(\"Server is listening on port %d\\n\", PORT); // 接受连接（省略 accept() 部分） close(server_fd); return 0; } 五、注意事项 5.1 backlog 参数的影响 含义：backlog 指定了内核为此套接字排队的最大连接数量。 实际效果：不同操作系统对 backlog 的处理可能不同，有的会对其进行限制或调整。 建议：设置合适的 backlog 值，根据服务器的负载能力和预期的并发连接数进行调整。 5.2 套接字的状态检查 问题：调用 listen() 之前，必须确保套接字已成功创建并绑定。 解决方案：在调用 listen() 之前，检查 socket() 和 bind() 的返回值，确保没有错误。 5.3 多次调用 listen() 问题：对同一个套接字多次调用 listen() 会导致错误。 解决方案：listen() 只需调用一次，后续操作由 accept() 处理。 5.4 权限问题 问题：绑定到低于 1024 的端口需要超级用户权限，否则 bind() 会失败，进而无法调用 listen()。 解决方案：以适当的权限运行程序，或选择高于 1024 的端口。 六、常见陷阱 6.1 忘记调用 listen() 问题：创建并绑定套接字后，未调用 listen()，直接调用 accept()，会导致程序阻塞或出错。 解决方案：在服务器程序中，确保在 bind() 之后调用 listen()，然后再调用 accept()。 6.2 backlog 设置过小 问题：backlog 设置过小，可能导致高并发情况下，新的连接请求被拒绝。 解决方案：根据服务器的处理能力，适当增大 backlog 值，避免连接被拒绝。 6.3 未正确处理返回值 问题：未检查 listen() 的返回值，无法及时发现监听失败的问题。 解决方案：始终检查 listen() 的返回值，处理可能的错误。 6.4 忽略 errno 的信息 问题：在 listen() 失败时，未使用 errno 提供的错误信息，导致调试困难。 解决方案：在错误处理时，使用 perror() 或 strerror(errno) 获取详细的错误描述。 七、listen() 函数的高级用法 7.1 调整系统限制 问题：操作系统可能对半连接队列和已完成连接队列的大小有上限。 解决方案：通过调整系统参数，增大连接队列的最大值。 7.1.1 Linux 系统参数调整 /proc/sys/net/core/somaxconn：定义了监听队列的最大长度，默认值通常为 128。 修改方法： 1 echo 1024 \u003e /proc/sys/net/core/somaxconn 或修改 /etc/sysctl.conf，添加：\n1 net.core.somaxconn = 1024 然后执行 sysctl -p 使配置生效。\n7.2 高并发服务器的优化 方法：结合 epoll、kqueue 等 I/O 多路复用机制，提升服务器的并发处理能力。 示例：使用 accept4() 函数，可以在接受连接时直接设置套接字为非阻塞模式，减少系统调用次数。 八、拓展资料：关键概念解释 8.1 TCP 三次握手 定义：TCP 协议中，建立连接需要经过的三个步骤，确保双方建立可靠的连接。 步骤： SYN：客户端发送 SYN 包，请求建立连接。 SYN-ACK：服务器收到后，回复 SYN-ACK 包，表示同意连接。 ACK：客户端收到 SYN-ACK 后，发送 ACK 包，连接建立成功。 8.2 半连接队列与全连接队列 半连接队列：存放已收到 SYN 包，但未完成三次握手的连接请求。 全连接队列：存放已完成三次握手，等待 accept() 处理的连接。 8.3 accept() 函数 作用：从已完成连接队列中取出一个已建立的连接，返回新的套接字文件描述符，用于与客户端进行通信。 注意：accept() 会阻塞，直到有新的连接可用，或设置为非阻塞模式。 8.4 I/O 多路复用 概念：使用单个线程或进程监控多个文件描述符的状态，提高资源利用率。 常用机制：select()、poll()、epoll()、kqueue() 等。 应用场景：高并发网络服务器，实时性要求高的应用。 九、示例代码：完整的服务器程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 #include #include #include #include #include #include #define PORT 8080 #define BACKLOG 10 int main() { int server_fd, new_socket; struct sockaddr_in address; int opt = 1; int addrlen = sizeof(address); // 忽略 SIGPIPE 信号，防止因为客户端断开连接导致程序终止 signal(SIGPIPE, SIG_IGN); // 创建套接字 if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) { perror(\"socket failed\"); return -1; } // 设置端口重用 if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, \u0026opt, sizeof(opt))) { perror(\"setsockopt failed\"); close(server_fd); return -1; } // 绑定地址 address.sin_family = AF_INET; address.sin_addr.s_addr = INADDR_ANY; address.sin_port = htons(PORT); if (bind(server_fd, (struct sockaddr *)\u0026address, sizeof(address)) \u003c 0) { perror(\"bind failed\"); close(server_fd); return -1; } // 开始监听 if (listen(server_fd, BACKLOG) \u003c 0) { perror(\"listen failed\"); close(server_fd); return -1; } printf(\"Server is listening on port %d\\n\", PORT); // 接受连接 while (1) { new_socket = accept(server_fd, (struct sockaddr *)\u0026address, (socklen_t *)\u0026addrlen); if (new_socket \u003c 0) { perror(\"accept failed\"); continue; } printf(\"Accepted a connection from %s:%d\\n\", inet_ntoa(address.sin_addr), ntohs(address.sin_port)); // 简单地向客户端发送一条消息 const char *message = \"Hello, Client!\\n\"; send(new_socket, message, strlen(message), 0); // 关闭与客户端的连接 close(new_socket); } close(server_fd); return 0; } ",
  "wordCount" : "2370",
  "inLanguage": "zh",
  "datePublished": "2024-01-04T10:13:49+08:00",
  "dateModified": "2024-01-04T10:13:49+08:00",
  "author":[{
    "@type": "Person",
    "name": "史玉浩"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84listen%E5%87%BD%E6%95%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "史玉浩的个人博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://oheyu.github.io/img/logo.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://oheyu.github.io/zh/" accesskey="h" title="史玉浩的个人博客 (Alt + H)">史玉浩的个人博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://oheyu.github.io/en/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://oheyu.github.io/zh/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/archives" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/categories" title="🧩分类">
                    <span>🧩分类</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://oheyu.github.io/zh/">主页</a>&nbsp;»&nbsp;<a href="https://oheyu.github.io/zh/posts/">📚 文章</a>&nbsp;»&nbsp;<a href="https://oheyu.github.io/zh/posts/tech/">👨🏻‍💻 技术</a></div>
    <h1 class="post-title entry-hint-parent">
      服务端的listen函数
    </h1>
    <div class="post-meta"><span title='2024-01-04 10:13:49 +0800 CST'>2024-01-04</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;史玉浩

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e4%b8%80listen-%e5%87%bd%e6%95%b0%e6%a6%82%e8%bf%b0" aria-label="一、listen() 函数概述">一、<code>listen()</code> 函数概述</a><ul>
                            
                    <li>
                        <a href="#11-%e5%ae%9a%e4%b9%89%e4%b8%8e%e4%bd%9c%e7%94%a8" aria-label="1.1 定义与作用">1.1 定义与作用</a></li>
                    <li>
                        <a href="#12-%e5%87%bd%e6%95%b0%e5%8e%9f%e5%9e%8b" aria-label="1.2 函数原型">1.2 函数原型</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%8clisten-%e5%87%bd%e6%95%b0%e7%9a%84%e5%8f%82%e6%95%b0%e4%b8%8e%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="二、listen() 函数的参数与返回值">二、<code>listen()</code> 函数的参数与返回值</a><ul>
                            
                    <li>
                        <a href="#21-%e5%8f%82%e6%95%b0%e8%a7%a3%e6%9e%90" aria-label="2.1 参数解析">2.1 参数解析</a></li>
                    <li>
                        <a href="#22-%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="2.2 返回值">2.2 返回值</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%89listen-%e5%87%bd%e6%95%b0%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="三、listen() 函数的工作原理">三、<code>listen()</code> 函数的工作原理</a><ul>
                            
                    <li>
                        <a href="#31-%e8%bf%9e%e6%8e%a5%e9%98%9f%e5%88%97%e7%9a%84%e6%a6%82%e5%bf%b5" aria-label="3.1 连接队列的概念">3.1 连接队列的概念</a></li>
                    <li>
                        <a href="#32-%e5%a5%97%e6%8e%a5%e5%ad%97%e7%8a%b6%e6%80%81%e7%9a%84%e8%bd%ac%e6%8d%a2" aria-label="3.2 套接字状态的转换">3.2 套接字状态的转换</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%9b%9blisten-%e7%9a%84%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b" aria-label="四、listen() 的使用示例">四、<code>listen()</code> 的使用示例</a><ul>
                            
                    <li>
                        <a href="#41-%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%e7%9b%91%e5%90%ac%e7%a4%ba%e4%be%8b" aria-label="4.1 服务器端监听示例">4.1 服务器端监听示例</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%94%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="五、注意事项">五、注意事项</a><ul>
                            
                    <li>
                        <a href="#51-backlog-%e5%8f%82%e6%95%b0%e7%9a%84%e5%bd%b1%e5%93%8d" aria-label="5.1 backlog 参数的影响">5.1 <code>backlog</code> 参数的影响</a></li>
                    <li>
                        <a href="#52-%e5%a5%97%e6%8e%a5%e5%ad%97%e7%9a%84%e7%8a%b6%e6%80%81%e6%a3%80%e6%9f%a5" aria-label="5.2 套接字的状态检查">5.2 套接字的状态检查</a></li>
                    <li>
                        <a href="#53-%e5%a4%9a%e6%ac%a1%e8%b0%83%e7%94%a8-listen" aria-label="5.3 多次调用 listen()">5.3 多次调用 <code>listen()</code></a></li>
                    <li>
                        <a href="#54-%e6%9d%83%e9%99%90%e9%97%ae%e9%a2%98" aria-label="5.4 权限问题">5.4 权限问题</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%85%ad%e5%b8%b8%e8%a7%81%e9%99%b7%e9%98%b1" aria-label="六、常见陷阱">六、常见陷阱</a><ul>
                            
                    <li>
                        <a href="#61-%e5%bf%98%e8%ae%b0%e8%b0%83%e7%94%a8-listen" aria-label="6.1 忘记调用 listen()">6.1 忘记调用 <code>listen()</code></a></li>
                    <li>
                        <a href="#62-backlog-%e8%ae%be%e7%bd%ae%e8%bf%87%e5%b0%8f" aria-label="6.2 backlog 设置过小">6.2 <code>backlog</code> 设置过小</a></li>
                    <li>
                        <a href="#63-%e6%9c%aa%e6%ad%a3%e7%a1%ae%e5%a4%84%e7%90%86%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="6.3 未正确处理返回值">6.3 未正确处理返回值</a></li>
                    <li>
                        <a href="#64-%e5%bf%bd%e7%95%a5-errno-%e7%9a%84%e4%bf%a1%e6%81%af" aria-label="6.4 忽略 errno 的信息">6.4 忽略 <code>errno</code> 的信息</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%83listen-%e5%87%bd%e6%95%b0%e7%9a%84%e9%ab%98%e7%ba%a7%e7%94%a8%e6%b3%95" aria-label="七、listen() 函数的高级用法">七、<code>listen()</code> 函数的高级用法</a><ul>
                            
                    <li>
                        <a href="#71-%e8%b0%83%e6%95%b4%e7%b3%bb%e7%bb%9f%e9%99%90%e5%88%b6" aria-label="7.1 调整系统限制">7.1 调整系统限制</a><ul>
                            
                    <li>
                        <a href="#711-linux-%e7%b3%bb%e7%bb%9f%e5%8f%82%e6%95%b0%e8%b0%83%e6%95%b4" aria-label="7.1.1 Linux 系统参数调整">7.1.1 Linux 系统参数调整</a></li></ul>
                    </li>
                    <li>
                        <a href="#72-%e9%ab%98%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e4%bc%98%e5%8c%96" aria-label="7.2 高并发服务器的优化">7.2 高并发服务器的优化</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%85%ab%e6%8b%93%e5%b1%95%e8%b5%84%e6%96%99%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5%e8%a7%a3%e9%87%8a" aria-label="八、拓展资料：关键概念解释">八、拓展资料：关键概念解释</a><ul>
                            
                    <li>
                        <a href="#81-tcp-%e4%b8%89%e6%ac%a1%e6%8f%a1%e6%89%8b" aria-label="8.1 TCP 三次握手">8.1 TCP 三次握手</a></li>
                    <li>
                        <a href="#82-%e5%8d%8a%e8%bf%9e%e6%8e%a5%e9%98%9f%e5%88%97%e4%b8%8e%e5%85%a8%e8%bf%9e%e6%8e%a5%e9%98%9f%e5%88%97" aria-label="8.2 半连接队列与全连接队列">8.2 半连接队列与全连接队列</a></li>
                    <li>
                        <a href="#83-accept-%e5%87%bd%e6%95%b0" aria-label="8.3 accept() 函数">8.3 <code>accept()</code> 函数</a></li>
                    <li>
                        <a href="#84-io-%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8" aria-label="8.4 I/O 多路复用">8.4 I/O 多路复用</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b9%9d%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81%e5%ae%8c%e6%95%b4%e7%9a%84%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%a8%8b%e5%ba%8f" aria-label="九、示例代码：完整的服务器程序">九、示例代码：完整的服务器程序</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
  <div class="post-content"><!-- more -->
<p><code>listen()</code> 函数在网络编程中是服务器端建立连接的关键步骤。它将套接字设置为被动监听模式，等待客户端的连接请求。本文将深入剖析 <code>listen()</code> 函数，从其定义、参数、返回值，到工作原理、使用示例和常见问题。</p>
<hr>
<h2 id="一listen-函数概述">一、<code>listen()</code> 函数概述<a hidden class="anchor" aria-hidden="true" href="#一listen-函数概述">#</a></h2>
<h3 id="11-定义与作用">1.1 定义与作用<a hidden class="anchor" aria-hidden="true" href="#11-定义与作用">#</a></h3>
<p><code>listen()</code> 函数用于将一个绑定（<code>bind()</code>）了地址和端口的套接字设置为 <strong>被动监听模式</strong>。这意味着套接字将准备接受客户端的连接请求，是构建服务器程序的重要一步。</p>
<h3 id="12-函数原型">1.2 函数原型<a hidden class="anchor" aria-hidden="true" href="#12-函数原型">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="二listen-函数的参数与返回值">二、<code>listen()</code> 函数的参数与返回值<a hidden class="anchor" aria-hidden="true" href="#二listen-函数的参数与返回值">#</a></h2>
<h3 id="21-参数解析">2.1 参数解析<a hidden class="anchor" aria-hidden="true" href="#21-参数解析">#</a></h3>
<ul>
<li><strong><code>sockfd</code></strong>：套接字文件描述符，由 <code>socket()</code> 函数创建并返回，并已通过 <code>bind()</code> 绑定了本地地址和端口。</li>
<li><strong><code>backlog</code></strong>：未完成连接队列的最大长度，即内核允许在监听套接字上排队的未处理连接的数量。</li>
</ul>
<h3 id="22-返回值">2.2 返回值<a hidden class="anchor" aria-hidden="true" href="#22-返回值">#</a></h3>
<ul>
<li><strong>成功</strong>：返回 <code>0</code>，表示套接字已成功进入监听状态。</li>
<li><strong>失败</strong>：返回 <code>-1</code>，并设置 <code>errno</code>，指示具体的错误原因。</li>
</ul>
<hr>
<h2 id="三listen-函数的工作原理">三、<code>listen()</code> 函数的工作原理<a hidden class="anchor" aria-hidden="true" href="#三listen-函数的工作原理">#</a></h2>
<h3 id="31-连接队列的概念">3.1 连接队列的概念<a hidden class="anchor" aria-hidden="true" href="#31-连接队列的概念">#</a></h3>
<p>在服务器端，TCP 协议使用两个队列来管理连接：</p>
<ol>
<li><strong>未完成连接队列</strong>：存放已收到客户端的 SYN 请求，但服务器尚未发送 ACK 的连接（半连接）。</li>
<li><strong>已完成连接队列</strong>：存放已完成三次握手的连接，等待 <code>accept()</code> 函数处理。</li>
</ol>
<p><code>backlog</code> 参数影响的是已完成连接队列的大小。</p>
<h3 id="32-套接字状态的转换">3.2 套接字状态的转换<a hidden class="anchor" aria-hidden="true" href="#32-套接字状态的转换">#</a></h3>
<p>调用 <code>listen()</code> 后，套接字从主动模式（默认）转换为被动模式，准备接受连接请求。此时，套接字可以接收来自客户端的 SYN 包，并按照 TCP 的三次握手流程建立连接。</p>
<hr>
<h2 id="四listen-的使用示例">四、<code>listen()</code> 的使用示例<a hidden class="anchor" aria-hidden="true" href="#四listen-的使用示例">#</a></h2>
<h3 id="41-服务器端监听示例">4.1 服务器端监听示例<a hidden class="anchor" aria-hidden="true" href="#41-服务器端监听示例">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PORT 8080
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BACKLOG 5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">server_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建套接字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">server_fd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置端口重用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setsockopt failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绑定地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 开始监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="n">BACKLOG</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Server is listening on port %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 接受连接（省略 accept() 部分）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="五注意事项">五、注意事项<a hidden class="anchor" aria-hidden="true" href="#五注意事项">#</a></h2>
<h3 id="51-backlog-参数的影响">5.1 <code>backlog</code> 参数的影响<a hidden class="anchor" aria-hidden="true" href="#51-backlog-参数的影响">#</a></h3>
<ul>
<li><strong>含义</strong>：<code>backlog</code> 指定了内核为此套接字排队的最大连接数量。</li>
<li><strong>实际效果</strong>：不同操作系统对 <code>backlog</code> 的处理可能不同，有的会对其进行限制或调整。</li>
<li><strong>建议</strong>：设置合适的 <code>backlog</code> 值，根据服务器的负载能力和预期的并发连接数进行调整。</li>
</ul>
<h3 id="52-套接字的状态检查">5.2 套接字的状态检查<a hidden class="anchor" aria-hidden="true" href="#52-套接字的状态检查">#</a></h3>
<ul>
<li><strong>问题</strong>：调用 <code>listen()</code> 之前，必须确保套接字已成功创建并绑定。</li>
<li><strong>解决方案</strong>：在调用 <code>listen()</code> 之前，检查 <code>socket()</code> 和 <code>bind()</code> 的返回值，确保没有错误。</li>
</ul>
<h3 id="53-多次调用-listen">5.3 多次调用 <code>listen()</code><a hidden class="anchor" aria-hidden="true" href="#53-多次调用-listen">#</a></h3>
<ul>
<li><strong>问题</strong>：对同一个套接字多次调用 <code>listen()</code> 会导致错误。</li>
<li><strong>解决方案</strong>：<code>listen()</code> 只需调用一次，后续操作由 <code>accept()</code> 处理。</li>
</ul>
<h3 id="54-权限问题">5.4 权限问题<a hidden class="anchor" aria-hidden="true" href="#54-权限问题">#</a></h3>
<ul>
<li><strong>问题</strong>：绑定到低于 1024 的端口需要超级用户权限，否则 <code>bind()</code> 会失败，进而无法调用 <code>listen()</code>。</li>
<li><strong>解决方案</strong>：以适当的权限运行程序，或选择高于 1024 的端口。</li>
</ul>
<hr>
<h2 id="六常见陷阱">六、常见陷阱<a hidden class="anchor" aria-hidden="true" href="#六常见陷阱">#</a></h2>
<h3 id="61-忘记调用-listen">6.1 忘记调用 <code>listen()</code><a hidden class="anchor" aria-hidden="true" href="#61-忘记调用-listen">#</a></h3>
<ul>
<li><strong>问题</strong>：创建并绑定套接字后，未调用 <code>listen()</code>，直接调用 <code>accept()</code>，会导致程序阻塞或出错。</li>
<li><strong>解决方案</strong>：在服务器程序中，确保在 <code>bind()</code> 之后调用 <code>listen()</code>，然后再调用 <code>accept()</code>。</li>
</ul>
<h3 id="62-backlog-设置过小">6.2 <code>backlog</code> 设置过小<a hidden class="anchor" aria-hidden="true" href="#62-backlog-设置过小">#</a></h3>
<ul>
<li><strong>问题</strong>：<code>backlog</code> 设置过小，可能导致高并发情况下，新的连接请求被拒绝。</li>
<li><strong>解决方案</strong>：根据服务器的处理能力，适当增大 <code>backlog</code> 值，避免连接被拒绝。</li>
</ul>
<h3 id="63-未正确处理返回值">6.3 未正确处理返回值<a hidden class="anchor" aria-hidden="true" href="#63-未正确处理返回值">#</a></h3>
<ul>
<li><strong>问题</strong>：未检查 <code>listen()</code> 的返回值，无法及时发现监听失败的问题。</li>
<li><strong>解决方案</strong>：始终检查 <code>listen()</code> 的返回值，处理可能的错误。</li>
</ul>
<h3 id="64-忽略-errno-的信息">6.4 忽略 <code>errno</code> 的信息<a hidden class="anchor" aria-hidden="true" href="#64-忽略-errno-的信息">#</a></h3>
<ul>
<li><strong>问题</strong>：在 <code>listen()</code> 失败时，未使用 <code>errno</code> 提供的错误信息，导致调试困难。</li>
<li><strong>解决方案</strong>：在错误处理时，使用 <code>perror()</code> 或 <code>strerror(errno)</code> 获取详细的错误描述。</li>
</ul>
<hr>
<h2 id="七listen-函数的高级用法">七、<code>listen()</code> 函数的高级用法<a hidden class="anchor" aria-hidden="true" href="#七listen-函数的高级用法">#</a></h2>
<h3 id="71-调整系统限制">7.1 调整系统限制<a hidden class="anchor" aria-hidden="true" href="#71-调整系统限制">#</a></h3>
<ul>
<li><strong>问题</strong>：操作系统可能对半连接队列和已完成连接队列的大小有上限。</li>
<li><strong>解决方案</strong>：通过调整系统参数，增大连接队列的最大值。</li>
</ul>
<h4 id="711-linux-系统参数调整">7.1.1 Linux 系统参数调整<a hidden class="anchor" aria-hidden="true" href="#711-linux-系统参数调整">#</a></h4>
<ul>
<li><strong><code>/proc/sys/net/core/somaxconn</code></strong>：定义了监听队列的最大长度，默认值通常为 128。</li>
<li><strong>修改方法</strong>：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1024</span> &gt; /proc/sys/net/core/somaxconn
</span></span></code></pre></td></tr></table>
</div>
</div><p>或修改 <code>/etc/sysctl.conf</code>，添加：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">net.core.somaxconn <span class="o">=</span> <span class="m">1024</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后执行 <code>sysctl -p</code> 使配置生效。</p>
<h3 id="72-高并发服务器的优化">7.2 高并发服务器的优化<a hidden class="anchor" aria-hidden="true" href="#72-高并发服务器的优化">#</a></h3>
<ul>
<li><strong>方法</strong>：结合 <code>epoll</code>、<code>kqueue</code> 等 I/O 多路复用机制，提升服务器的并发处理能力。</li>
<li><strong>示例</strong>：使用 <code>accept4()</code> 函数，可以在接受连接时直接设置套接字为非阻塞模式，减少系统调用次数。</li>
</ul>
<hr>
<h2 id="八拓展资料关键概念解释">八、拓展资料：关键概念解释<a hidden class="anchor" aria-hidden="true" href="#八拓展资料关键概念解释">#</a></h2>
<h3 id="81-tcp-三次握手">8.1 TCP 三次握手<a hidden class="anchor" aria-hidden="true" href="#81-tcp-三次握手">#</a></h3>
<ul>
<li><strong>定义</strong>：TCP 协议中，建立连接需要经过的三个步骤，确保双方建立可靠的连接。</li>
<li><strong>步骤</strong>：
<ol>
<li><strong>SYN</strong>：客户端发送 SYN 包，请求建立连接。</li>
<li><strong>SYN-ACK</strong>：服务器收到后，回复 SYN-ACK 包，表示同意连接。</li>
<li><strong>ACK</strong>：客户端收到 SYN-ACK 后，发送 ACK 包，连接建立成功。</li>
</ol>
</li>
</ul>
<h3 id="82-半连接队列与全连接队列">8.2 半连接队列与全连接队列<a hidden class="anchor" aria-hidden="true" href="#82-半连接队列与全连接队列">#</a></h3>
<ul>
<li><strong>半连接队列</strong>：存放已收到 SYN 包，但未完成三次握手的连接请求。</li>
<li><strong>全连接队列</strong>：存放已完成三次握手，等待 <code>accept()</code> 处理的连接。</li>
</ul>
<h3 id="83-accept-函数">8.3 <code>accept()</code> 函数<a hidden class="anchor" aria-hidden="true" href="#83-accept-函数">#</a></h3>
<ul>
<li><strong>作用</strong>：从已完成连接队列中取出一个已建立的连接，返回新的套接字文件描述符，用于与客户端进行通信。</li>
<li><strong>注意</strong>：<code>accept()</code> 会阻塞，直到有新的连接可用，或设置为非阻塞模式。</li>
</ul>
<h3 id="84-io-多路复用">8.4 I/O 多路复用<a hidden class="anchor" aria-hidden="true" href="#84-io-多路复用">#</a></h3>
<ul>
<li><strong>概念</strong>：使用单个线程或进程监控多个文件描述符的状态，提高资源利用率。</li>
<li><strong>常用机制</strong>：<code>select()</code>、<code>poll()</code>、<code>epoll()</code>、<code>kqueue()</code> 等。</li>
<li><strong>应用场景</strong>：高并发网络服务器，实时性要求高的应用。</li>
</ul>
<hr>
<h2 id="九示例代码完整的服务器程序">九、示例代码：完整的服务器程序<a hidden class="anchor" aria-hidden="true" href="#九示例代码完整的服务器程序">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PORT 8080
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BACKLOG 10
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">server_fd</span><span class="p">,</span> <span class="n">new_socket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 忽略 SIGPIPE 信号，防止因为客户端断开连接导致程序终止
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建套接字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">server_fd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置端口重用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setsockopt failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绑定地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 开始监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="n">BACKLOG</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Server is listening on port %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 接受连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_socket</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="kt">socklen_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">new_socket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Accepted a connection from %s:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 简单地向客户端发送一条消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Hello, Client!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">send</span><span class="p">(</span><span class="n">new_socket</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 关闭与客户端的连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">close</span><span class="p">(</span><span class="n">new_socket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://oheyu.github.io/zh/tags/linux/">Linux</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84accept%E5%87%BD%E6%95%B0/">
    <span class="title">« 上一页</span>
    <br>
    <span>服务端的accept函数</span>
  </a>
  <a class="next" href="https://oheyu.github.io/zh/posts/tech/bind%E5%87%BD%E6%95%B0/">
    <span class="title">下一页 »</span>
    <br>
    <span>Bind函数</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://oheyu.github.io/zh/">史玉浩的个人博客</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
