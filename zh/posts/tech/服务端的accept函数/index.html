<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>服务端的accept函数 | 史玉浩的个人博客</title>
<meta name="keywords" content="Linux">
<meta name="description" content="一、accept() 函数概述 1.1 定义与作用 accept() 函数用于从监听套接字的已完成连接队列中取出一个已建立的连接，返回一个新的套接字文件描述符，用于与客">
<meta name="author" content="史玉浩">
<link rel="canonical" href="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84accept%E5%87%BD%E6%95%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9c78afd72529c14d4d3c0fa583c3e82265e0d8a303d475223d3b37442260ba22.css" integrity="sha256-nHiv1yUpwU1NPA&#43;lg8PoImXg2KMD1HUiPTs3RCJguiI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://oheyu.github.io/img/logo.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://oheyu.github.io/img/logo.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://oheyu.github.io/img/logo.svg">
<link rel="apple-touch-icon" href="https://oheyu.github.io/logo.svg">
<link rel="mask-icon" href="https://oheyu.github.io/logo.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84accept%E5%87%BD%E6%95%B0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

  

<meta property="og:title" content="服务端的accept函数" />
<meta property="og:description" content="一、accept() 函数概述 1.1 定义与作用 accept() 函数用于从监听套接字的已完成连接队列中取出一个已建立的连接，返回一个新的套接字文件描述符，用于与客" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84accept%E5%87%BD%E6%95%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-13T10:23:06+08:00" />
<meta property="article:modified_time" content="2024-01-13T10:23:06+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="服务端的accept函数"/>
<meta name="twitter:description" content="一、accept() 函数概述 1.1 定义与作用 accept() 函数用于从监听套接字的已完成连接队列中取出一个已建立的连接，返回一个新的套接字文件描述符，用于与客"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚 文章",
      "item": "https://oheyu.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "👨🏻‍💻 技术",
      "item": "https://oheyu.github.io/zh/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "服务端的accept函数",
      "item": "https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84accept%E5%87%BD%E6%95%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "服务端的accept函数",
  "name": "服务端的accept函数",
  "description": "一、accept() 函数概述 1.1 定义与作用 accept() 函数用于从监听套接字的已完成连接队列中取出一个已建立的连接，返回一个新的套接字文件描述符，用于与客",
  "keywords": [
    "Linux"
  ],
  "articleBody": "\r一、accept() 函数概述 1.1 定义与作用 accept() 函数用于从监听套接字的已完成连接队列中取出一个已建立的连接，返回一个新的套接字文件描述符，用于与客户端进行通信。在 TCP 服务器编程中，这是处理客户端连接的关键步骤。\n1.2 函数原型 1 2 3 4 #include #include int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen); 二、accept() 函数的参数与返回值 2.1 参数解析 sockfd：监听套接字的文件描述符，由 socket() 创建，并经过 bind() 和 listen() 函数设置为监听状态。 addr：可选参数，指向 struct sockaddr 类型的指针，用于存储客户端的地址信息。 addrlen：指向一个 socklen_t 类型的变量，初始值为 addr 所指向的结构体的长度，返回时包含客户端地址的实际长度。 2.2 返回值 成功：返回一个新的套接字文件描述符，用于与客户端通信。 失败：返回 -1，并设置 errno，指示具体的错误原因。 三、accept() 函数的工作原理 3.1 连接队列 在调用 listen() 后，套接字进入被动监听状态，内核为其维护两个队列：\n未完成连接队列：存放已收到客户端的 SYN 请求，但尚未完成三次握手的连接。 已完成连接队列：存放已完成三次握手的连接，等待应用程序调用 accept() 取出处理。 accept() 函数从已完成连接队列中取出一个连接，返回新的套接字描述符。\n3.2 套接字的区别 监听套接字 (sockfd)：用于监听新的连接请求。 已连接套接字：由 accept() 返回，用于与特定客户端通信。 四、accept() 的使用示例 4.1 基本的服务器接收连接示例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 #include #include #include #include #include #define PORT 8080 #define BACKLOG 5 int main() { int listen_fd, conn_fd; struct sockaddr_in server_addr, client_addr; socklen_t client_addrlen = sizeof(client_addr); // 创建套接字 if ((listen_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1) { perror(\"socket creation failed\"); return -1; } // 绑定地址 memset(\u0026server_addr, 0, sizeof(server_addr)); server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = INADDR_ANY; server_addr.sin_port = htons(PORT); if (bind(listen_fd, (struct sockaddr *)\u0026server_addr, sizeof(server_addr)) == -1) { perror(\"bind failed\"); close(listen_fd); return -1; } // 开始监听 if (listen(listen_fd, BACKLOG) == -1) { perror(\"listen failed\"); close(listen_fd); return -1; } printf(\"Server is listening on port %d...\\n\", PORT); // 接受连接 if ((conn_fd = accept(listen_fd, (struct sockaddr *)\u0026client_addr, \u0026client_addrlen)) == -1) { perror(\"accept failed\"); close(listen_fd); return -1; } printf(\"Accepted a connection from %s:%d\\n\", inet_ntoa(client_addr.sin_addr), ntohs(client_addr.sin_port)); // 与客户端通信... // 关闭套接字 close(conn_fd); close(listen_fd); return 0; } 五、使用注意事项 5.1 accept() 的阻塞行为 问题：默认情况下，accept() 是阻塞的，如果已完成连接队列为空，accept() 将阻塞，直到有新的连接。 解决方案： 非阻塞模式：将监听套接字设置为非阻塞模式，若无连接则立即返回 -1，并设置 errno 为 EAGAIN 或 EWOULDBLOCK。 I/O 多路复用：使用 select()、poll()、epoll() 等机制，在调用 accept() 之前检测套接字是否可读。 5.2 addr 和 addrlen 参数 可选性：addr 和 addrlen 可以为 NULL，如果不需要获取客户端地址信息。 注意事项：若需要获取客户端信息，必须提供有效的 addr 和 addrlen，并确保 addrlen 指向的变量初始化为 addr 的长度。 5.3 文件描述符的管理 问题：accept() 返回的新套接字描述符需要妥善管理，及时关闭，防止文件描述符耗尽。 解决方案：在通信结束后，调用 close() 关闭已连接套接字。 5.4 多线程和并发处理 场景：在高并发服务器中，需要同时处理多个客户端连接。 解决方案：每次 accept() 后，创建新线程或进程处理连接，或使用事件驱动的方式。 六、常见问题 6.1 忘记检查返回值 问题：未检查 accept() 的返回值，无法及时发现错误。 解决方案：始终检查返回值，处理可能的错误。 6.2 忽略 EINTR 错误 问题：accept() 可能被信号中断，返回 -1，并设置 errno 为 EINTR。 解决方案：在收到 EINTR 错误时，重新调用 accept()。 1 2 3 4 5 6 7 8 while ((conn_fd = accept(listen_fd, (struct sockaddr *)\u0026client_addr, \u0026client_addrlen)) == -1) { if (errno == EINTR) continue; else { perror(\"accept failed\"); break; } } 6.3 文件描述符耗尽 问题：未及时关闭已连接套接字，导致文件描述符耗尽，无法接受新的连接。 解决方案：妥善管理套接字的生命周期，及时关闭不再使用的套接字。 6.4 拒绝服务攻击的防范 问题：恶意客户端大量连接服务器，导致资源耗尽。 解决方案： 限制每个客户端的连接数。 实现连接超时机制，关闭长时间未活动的连接。 使用防火墙和入侵检测系统。 七、accept() 函数的高级用法 7.1 使用 accept4() 函数 简介：accept4() 是 Linux 特有的系统调用，功能类似于 accept()，但增加了一个 flags 参数。 函数原型： 1 2 3 #include int accept4(int sockfd, struct sockaddr *addr, socklen_t *addrlen, int flags); 优势： 可以在接受连接的同时设置新套接字的属性，如非阻塞模式 (O_NONBLOCK)。 减少系统调用次数，提高性能。 7.2 非阻塞 accept() 方法：将监听套接字设置为非阻塞模式，或使用 accept4() 设置 O_NONBLOCK 标志。 应用场景：在事件驱动的服务器中，避免阻塞在 accept() 调用上。 7.3 获取客户端的更多信息 方法：使用 getpeername() 获取已连接套接字对端的地址信息。 示例： 1 2 3 4 5 6 7 struct sockaddr_in peer_addr; socklen_t peer_len = sizeof(peer_addr); if (getpeername(conn_fd, (struct sockaddr *)\u0026peer_addr, \u0026peer_len) == 0) { printf(\"Connected to %s:%d\\n\", inet_ntoa(peer_addr.sin_addr), ntohs(peer_addr.sin_port)); } 八、拓展资料：关键概念解释 8.1 阻塞与非阻塞模式 阻塞模式：默认情况下，accept() 会阻塞，直到有新的连接或发生错误。 非阻塞模式：accept() 立即返回，若无连接，则返回 -1，并设置 errno 为 EAGAIN 或 EWOULDBLOCK。 设置方法：使用 fcntl() 函数设置套接字为非阻塞模式。 1 2 3 4 #include int flags = fcntl(listen_fd, F_GETFL, 0); fcntl(listen_fd, F_SETFL, flags | O_NONBLOCK); 8.2 I/O 多路复用 概念：使用单个线程或进程监控多个文件描述符，提高资源利用率。 常用机制：select()、poll()、epoll()。 应用场景：高并发服务器，避免为每个连接创建线程或进程。 8.3 accept() 与多线程 问题：在多线程服务器中，多个线程同时调用 accept() 可能导致竞争。 解决方案： 使用同步机制，如互斥锁，确保只有一个线程调用 accept()。 或者将监听套接字设置为非阻塞模式，结合事件驱动模型。 8.4 SO_REUSEADDR 与 SO_REUSEPORT SO_REUSEADDR：允许绑定已在使用的地址，常用于服务器重启时快速重新绑定端口。 SO_REUSEPORT：允许多个套接字绑定到同一 IP 和端口，常用于多线程或多进程服务器。 九、示例代码：多线程服务器示例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 #include #include #include #include #include #include #include #define PORT 8080 #define BACKLOG 5 void *handle_client(void *arg) { int conn_fd = *(int *)arg; free(arg); char buffer[1024]; ssize_t bytes_read; // 通信处理 while ((bytes_read = recv(conn_fd, buffer, sizeof(buffer), 0)) \u003e 0) { send(conn_fd, buffer, bytes_read, 0); } close(conn_fd); return NULL; } int main() { int listen_fd; struct sockaddr_in server_addr, client_addr; socklen_t client_addrlen = sizeof(client_addr); // 创建套接字 if ((listen_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1) { perror(\"socket creation failed\"); return -1; } // 绑定地址 memset(\u0026server_addr, 0, sizeof(server_addr)); server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = INADDR_ANY; server_addr.sin_port = htons(PORT); if (bind(listen_fd, (struct sockaddr *)\u0026server_addr, sizeof(server_addr)) == -1) { perror(\"bind failed\"); close(listen_fd); return -1; } // 开始监听 if (listen(listen_fd, BACKLOG) == -1) { perror(\"listen failed\"); close(listen_fd); return -1; } printf(\"Server is listening on port %d...\\n\", PORT); // 接受并处理连接 while (1) { int *conn_fd = malloc(sizeof(int)); if ((*conn_fd = accept(listen_fd, (struct sockaddr *)\u0026client_addr, \u0026client_addrlen)) == -1) { perror(\"accept failed\"); free(conn_fd); continue; } printf(\"Accepted a connection from %s:%d\\n\", inet_ntoa(client_addr.sin_addr), ntohs(client_addr.sin_port)); pthread_t tid; if (pthread_create(\u0026tid, NULL, handle_client, conn_fd) != 0) { perror(\"pthread_create failed\"); close(*conn_fd); free(conn_fd); } else { pthread_detach(tid); } } close(listen_fd); return 0; } ",
  "wordCount" : "2502",
  "inLanguage": "zh",
  "datePublished": "2024-01-13T10:23:06+08:00",
  "dateModified": "2024-01-13T10:23:06+08:00",
  "author":[{
    "@type": "Person",
    "name": "史玉浩"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84accept%E5%87%BD%E6%95%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "史玉浩的个人博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://oheyu.github.io/img/logo.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://oheyu.github.io/zh/" accesskey="h" title="史玉浩的个人博客 (Alt + H)">史玉浩的个人博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://oheyu.github.io/en/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://oheyu.github.io/zh/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/archives" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/categories" title="🧩分类">
                    <span>🧩分类</span>
                </a>
            </li>
            <li>
                <a href="https://oheyu.github.io/zh/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://oheyu.github.io/zh/">主页</a>&nbsp;»&nbsp;<a href="https://oheyu.github.io/zh/posts/">📚 文章</a>&nbsp;»&nbsp;<a href="https://oheyu.github.io/zh/posts/tech/">👨🏻‍💻 技术</a></div>
    <h1 class="post-title entry-hint-parent">
      服务端的accept函数
    </h1>
    <div class="post-meta"><span title='2024-01-13 10:23:06 +0800 CST'>2024-01-13</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;史玉浩

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e4%b8%80accept-%e5%87%bd%e6%95%b0%e6%a6%82%e8%bf%b0" aria-label="一、accept() 函数概述">一、<code>accept()</code> 函数概述</a><ul>
                            
                    <li>
                        <a href="#11-%e5%ae%9a%e4%b9%89%e4%b8%8e%e4%bd%9c%e7%94%a8" aria-label="1.1 定义与作用">1.1 定义与作用</a></li>
                    <li>
                        <a href="#12-%e5%87%bd%e6%95%b0%e5%8e%9f%e5%9e%8b" aria-label="1.2 函数原型">1.2 函数原型</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%8caccept-%e5%87%bd%e6%95%b0%e7%9a%84%e5%8f%82%e6%95%b0%e4%b8%8e%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="二、accept() 函数的参数与返回值">二、<code>accept()</code> 函数的参数与返回值</a><ul>
                            
                    <li>
                        <a href="#21-%e5%8f%82%e6%95%b0%e8%a7%a3%e6%9e%90" aria-label="2.1 参数解析">2.1 参数解析</a></li>
                    <li>
                        <a href="#22-%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="2.2 返回值">2.2 返回值</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%89accept-%e5%87%bd%e6%95%b0%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="三、accept() 函数的工作原理">三、<code>accept()</code> 函数的工作原理</a><ul>
                            
                    <li>
                        <a href="#31-%e8%bf%9e%e6%8e%a5%e9%98%9f%e5%88%97" aria-label="3.1 连接队列">3.1 连接队列</a></li>
                    <li>
                        <a href="#32-%e5%a5%97%e6%8e%a5%e5%ad%97%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="3.2 套接字的区别">3.2 套接字的区别</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%9b%9baccept-%e7%9a%84%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b" aria-label="四、accept() 的使用示例">四、<code>accept()</code> 的使用示例</a><ul>
                            
                    <li>
                        <a href="#41-%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%8e%a5%e6%94%b6%e8%bf%9e%e6%8e%a5%e7%a4%ba%e4%be%8b" aria-label="4.1 基本的服务器接收连接示例">4.1 基本的服务器接收连接示例</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%94%e4%bd%bf%e7%94%a8%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="五、使用注意事项">五、使用注意事项</a><ul>
                            
                    <li>
                        <a href="#51-accept-%e7%9a%84%e9%98%bb%e5%a1%9e%e8%a1%8c%e4%b8%ba" aria-label="5.1 accept() 的阻塞行为">5.1 <code>accept()</code> 的阻塞行为</a></li>
                    <li>
                        <a href="#52-addr-%e5%92%8c-addrlen-%e5%8f%82%e6%95%b0" aria-label="5.2 addr 和 addrlen 参数">5.2 <code>addr</code> 和 <code>addrlen</code> 参数</a></li>
                    <li>
                        <a href="#53-%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e7%9a%84%e7%ae%a1%e7%90%86" aria-label="5.3 文件描述符的管理">5.3 文件描述符的管理</a></li>
                    <li>
                        <a href="#54-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%92%8c%e5%b9%b6%e5%8f%91%e5%a4%84%e7%90%86" aria-label="5.4 多线程和并发处理">5.4 多线程和并发处理</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%85%ad%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98" aria-label="六、常见问题">六、常见问题</a><ul>
                            
                    <li>
                        <a href="#61-%e5%bf%98%e8%ae%b0%e6%a3%80%e6%9f%a5%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="6.1 忘记检查返回值">6.1 忘记检查返回值</a></li>
                    <li>
                        <a href="#62-%e5%bf%bd%e7%95%a5-eintr-%e9%94%99%e8%af%af" aria-label="6.2 忽略 EINTR 错误">6.2 忽略 <code>EINTR</code> 错误</a></li>
                    <li>
                        <a href="#63-%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e8%80%97%e5%b0%bd" aria-label="6.3 文件描述符耗尽">6.3 文件描述符耗尽</a></li>
                    <li>
                        <a href="#64-%e6%8b%92%e7%bb%9d%e6%9c%8d%e5%8a%a1%e6%94%bb%e5%87%bb%e7%9a%84%e9%98%b2%e8%8c%83" aria-label="6.4 拒绝服务攻击的防范">6.4 拒绝服务攻击的防范</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%83accept-%e5%87%bd%e6%95%b0%e7%9a%84%e9%ab%98%e7%ba%a7%e7%94%a8%e6%b3%95" aria-label="七、accept() 函数的高级用法">七、<code>accept()</code> 函数的高级用法</a><ul>
                            
                    <li>
                        <a href="#71-%e4%bd%bf%e7%94%a8-accept4-%e5%87%bd%e6%95%b0" aria-label="7.1 使用 accept4() 函数">7.1 使用 <code>accept4()</code> 函数</a></li>
                    <li>
                        <a href="#72-%e9%9d%9e%e9%98%bb%e5%a1%9e-accept" aria-label="7.2 非阻塞 accept()">7.2 非阻塞 <code>accept()</code></a></li>
                    <li>
                        <a href="#73-%e8%8e%b7%e5%8f%96%e5%ae%a2%e6%88%b7%e7%ab%af%e7%9a%84%e6%9b%b4%e5%a4%9a%e4%bf%a1%e6%81%af" aria-label="7.3 获取客户端的更多信息">7.3 获取客户端的更多信息</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%85%ab%e6%8b%93%e5%b1%95%e8%b5%84%e6%96%99%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5%e8%a7%a3%e9%87%8a" aria-label="八、拓展资料：关键概念解释">八、拓展资料：关键概念解释</a><ul>
                            
                    <li>
                        <a href="#81-%e9%98%bb%e5%a1%9e%e4%b8%8e%e9%9d%9e%e9%98%bb%e5%a1%9e%e6%a8%a1%e5%bc%8f" aria-label="8.1 阻塞与非阻塞模式">8.1 阻塞与非阻塞模式</a></li>
                    <li>
                        <a href="#82-io-%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8" aria-label="8.2 I/O 多路复用">8.2 I/O 多路复用</a></li>
                    <li>
                        <a href="#83-accept-%e4%b8%8e%e5%a4%9a%e7%ba%bf%e7%a8%8b" aria-label="8.3 accept() 与多线程">8.3 <code>accept()</code> 与多线程</a></li>
                    <li>
                        <a href="#84-so_reuseaddr-%e4%b8%8e-so_reuseport" aria-label="8.4 SO_REUSEADDR 与 SO_REUSEPORT">8.4 <code>SO_REUSEADDR</code> 与 <code>SO_REUSEPORT</code></a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b9%9d%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81%e5%a4%9a%e7%ba%bf%e7%a8%8b%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%a4%ba%e4%be%8b" aria-label="九、示例代码：多线程服务器示例">九、示例代码：多线程服务器示例</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
  <div class="post-content"><!-- more -->
<h2 id="一accept-函数概述">一、<code>accept()</code> 函数概述<a hidden class="anchor" aria-hidden="true" href="#一accept-函数概述">#</a></h2>
<h3 id="11-定义与作用">1.1 定义与作用<a hidden class="anchor" aria-hidden="true" href="#11-定义与作用">#</a></h3>
<p><code>accept()</code> 函数用于从监听套接字的已完成连接队列中取出一个已建立的连接，返回一个新的套接字文件描述符，用于与客户端进行通信。在 TCP 服务器编程中，这是处理客户端连接的关键步骤。</p>
<h3 id="12-函数原型">1.2 函数原型<a hidden class="anchor" aria-hidden="true" href="#12-函数原型">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="二accept-函数的参数与返回值">二、<code>accept()</code> 函数的参数与返回值<a hidden class="anchor" aria-hidden="true" href="#二accept-函数的参数与返回值">#</a></h2>
<h3 id="21-参数解析">2.1 参数解析<a hidden class="anchor" aria-hidden="true" href="#21-参数解析">#</a></h3>
<ul>
<li><strong><code>sockfd</code></strong>：监听套接字的文件描述符，由 <code>socket()</code> 创建，并经过 <code>bind()</code> 和 <code>listen()</code> 函数设置为监听状态。</li>
<li><strong><code>addr</code></strong>：可选参数，指向 <code>struct sockaddr</code> 类型的指针，用于存储客户端的地址信息。</li>
<li><strong><code>addrlen</code></strong>：指向一个 <code>socklen_t</code> 类型的变量，初始值为 <code>addr</code> 所指向的结构体的长度，返回时包含客户端地址的实际长度。</li>
</ul>
<h3 id="22-返回值">2.2 返回值<a hidden class="anchor" aria-hidden="true" href="#22-返回值">#</a></h3>
<ul>
<li><strong>成功</strong>：返回一个新的套接字文件描述符，用于与客户端通信。</li>
<li><strong>失败</strong>：返回 <code>-1</code>，并设置 <code>errno</code>，指示具体的错误原因。</li>
</ul>
<hr>
<h2 id="三accept-函数的工作原理">三、<code>accept()</code> 函数的工作原理<a hidden class="anchor" aria-hidden="true" href="#三accept-函数的工作原理">#</a></h2>
<h3 id="31-连接队列">3.1 连接队列<a hidden class="anchor" aria-hidden="true" href="#31-连接队列">#</a></h3>
<p>在调用 <code>listen()</code> 后，套接字进入被动监听状态，内核为其维护两个队列：</p>
<ol>
<li><strong>未完成连接队列</strong>：存放已收到客户端的 SYN 请求，但尚未完成三次握手的连接。</li>
<li><strong>已完成连接队列</strong>：存放已完成三次握手的连接，等待应用程序调用 <code>accept()</code> 取出处理。</li>
</ol>
<p><code>accept()</code> 函数从已完成连接队列中取出一个连接，返回新的套接字描述符。</p>
<h3 id="32-套接字的区别">3.2 套接字的区别<a hidden class="anchor" aria-hidden="true" href="#32-套接字的区别">#</a></h3>
<ul>
<li><strong>监听套接字 (<code>sockfd</code>)</strong>：用于监听新的连接请求。</li>
<li><strong>已连接套接字</strong>：由 <code>accept()</code> 返回，用于与特定客户端通信。</li>
</ul>
<hr>
<h2 id="四accept-的使用示例">四、<code>accept()</code> 的使用示例<a hidden class="anchor" aria-hidden="true" href="#四accept-的使用示例">#</a></h2>
<h3 id="41-基本的服务器接收连接示例">4.1 基本的服务器接收连接示例<a hidden class="anchor" aria-hidden="true" href="#41-基本的服务器接收连接示例">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PORT 8080
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BACKLOG 5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">listen_fd</span><span class="p">,</span> <span class="n">conn_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">socklen_t</span> <span class="n">client_addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建套接字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">listen_fd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket creation failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绑定地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 开始监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="n">BACKLOG</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Server is listening on port %d...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 接受连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">conn_fd</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addrlen</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Accepted a connection from %s:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 与客户端通信...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 关闭套接字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="五使用注意事项">五、使用注意事项<a hidden class="anchor" aria-hidden="true" href="#五使用注意事项">#</a></h2>
<h3 id="51-accept-的阻塞行为">5.1 <code>accept()</code> 的阻塞行为<a hidden class="anchor" aria-hidden="true" href="#51-accept-的阻塞行为">#</a></h3>
<ul>
<li><strong>问题</strong>：默认情况下，<code>accept()</code> 是阻塞的，如果已完成连接队列为空，<code>accept()</code> 将阻塞，直到有新的连接。</li>
<li><strong>解决方案</strong>：
<ul>
<li><strong>非阻塞模式</strong>：将监听套接字设置为非阻塞模式，若无连接则立即返回 <code>-1</code>，并设置 <code>errno</code> 为 <code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>。</li>
<li><strong>I/O 多路复用</strong>：使用 <code>select()</code>、<code>poll()</code>、<code>epoll()</code> 等机制，在调用 <code>accept()</code> 之前检测套接字是否可读。</li>
</ul>
</li>
</ul>
<h3 id="52-addr-和-addrlen-参数">5.2 <code>addr</code> 和 <code>addrlen</code> 参数<a hidden class="anchor" aria-hidden="true" href="#52-addr-和-addrlen-参数">#</a></h3>
<ul>
<li><strong>可选性</strong>：<code>addr</code> 和 <code>addrlen</code> 可以为 <code>NULL</code>，如果不需要获取客户端地址信息。</li>
<li><strong>注意事项</strong>：若需要获取客户端信息，必须提供有效的 <code>addr</code> 和 <code>addrlen</code>，并确保 <code>addrlen</code> 指向的变量初始化为 <code>addr</code> 的长度。</li>
</ul>
<h3 id="53-文件描述符的管理">5.3 文件描述符的管理<a hidden class="anchor" aria-hidden="true" href="#53-文件描述符的管理">#</a></h3>
<ul>
<li><strong>问题</strong>：<code>accept()</code> 返回的新套接字描述符需要妥善管理，及时关闭，防止文件描述符耗尽。</li>
<li><strong>解决方案</strong>：在通信结束后，调用 <code>close()</code> 关闭已连接套接字。</li>
</ul>
<h3 id="54-多线程和并发处理">5.4 多线程和并发处理<a hidden class="anchor" aria-hidden="true" href="#54-多线程和并发处理">#</a></h3>
<ul>
<li><strong>场景</strong>：在高并发服务器中，需要同时处理多个客户端连接。</li>
<li><strong>解决方案</strong>：每次 <code>accept()</code> 后，创建新线程或进程处理连接，或使用事件驱动的方式。</li>
</ul>
<hr>
<h2 id="六常见问题">六、常见问题<a hidden class="anchor" aria-hidden="true" href="#六常见问题">#</a></h2>
<h3 id="61-忘记检查返回值">6.1 忘记检查返回值<a hidden class="anchor" aria-hidden="true" href="#61-忘记检查返回值">#</a></h3>
<ul>
<li><strong>问题</strong>：未检查 <code>accept()</code> 的返回值，无法及时发现错误。</li>
<li><strong>解决方案</strong>：始终检查返回值，处理可能的错误。</li>
</ul>
<h3 id="62-忽略-eintr-错误">6.2 忽略 <code>EINTR</code> 错误<a hidden class="anchor" aria-hidden="true" href="#62-忽略-eintr-错误">#</a></h3>
<ul>
<li><strong>问题</strong>：<code>accept()</code> 可能被信号中断，返回 <code>-1</code>，并设置 <code>errno</code> 为 <code>EINTR</code>。</li>
<li><strong>解决方案</strong>：在收到 <code>EINTR</code> 错误时，重新调用 <code>accept()</code>。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">((</span><span class="n">conn_fd</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addrlen</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="63-文件描述符耗尽">6.3 文件描述符耗尽<a hidden class="anchor" aria-hidden="true" href="#63-文件描述符耗尽">#</a></h3>
<ul>
<li><strong>问题</strong>：未及时关闭已连接套接字，导致文件描述符耗尽，无法接受新的连接。</li>
<li><strong>解决方案</strong>：妥善管理套接字的生命周期，及时关闭不再使用的套接字。</li>
</ul>
<h3 id="64-拒绝服务攻击的防范">6.4 拒绝服务攻击的防范<a hidden class="anchor" aria-hidden="true" href="#64-拒绝服务攻击的防范">#</a></h3>
<ul>
<li><strong>问题</strong>：恶意客户端大量连接服务器，导致资源耗尽。</li>
<li><strong>解决方案</strong>：
<ul>
<li>限制每个客户端的连接数。</li>
<li>实现连接超时机制，关闭长时间未活动的连接。</li>
<li>使用防火墙和入侵检测系统。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="七accept-函数的高级用法">七、<code>accept()</code> 函数的高级用法<a hidden class="anchor" aria-hidden="true" href="#七accept-函数的高级用法">#</a></h2>
<h3 id="71-使用-accept4-函数">7.1 使用 <code>accept4()</code> 函数<a hidden class="anchor" aria-hidden="true" href="#71-使用-accept4-函数">#</a></h3>
<ul>
<li><strong>简介</strong>：<code>accept4()</code> 是 Linux 特有的系统调用，功能类似于 <code>accept()</code>，但增加了一个 <code>flags</code> 参数。</li>
<li><strong>函数原型</strong>：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">accept4</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>优势</strong>：
<ul>
<li>可以在接受连接的同时设置新套接字的属性，如非阻塞模式 (<code>O_NONBLOCK</code>)。</li>
<li>减少系统调用次数，提高性能。</li>
</ul>
</li>
</ul>
<h3 id="72-非阻塞-accept">7.2 非阻塞 <code>accept()</code><a hidden class="anchor" aria-hidden="true" href="#72-非阻塞-accept">#</a></h3>
<ul>
<li><strong>方法</strong>：将监听套接字设置为非阻塞模式，或使用 <code>accept4()</code> 设置 <code>O_NONBLOCK</code> 标志。</li>
<li><strong>应用场景</strong>：在事件驱动的服务器中，避免阻塞在 <code>accept()</code> 调用上。</li>
</ul>
<h3 id="73-获取客户端的更多信息">7.3 获取客户端的更多信息<a hidden class="anchor" aria-hidden="true" href="#73-获取客户端的更多信息">#</a></h3>
<ul>
<li><strong>方法</strong>：使用 <code>getpeername()</code> 获取已连接套接字对端的地址信息。</li>
<li><strong>示例</strong>：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">peer_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">socklen_t</span> <span class="n">peer_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">peer_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">getpeername</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peer_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Connected to %s:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">peer_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="八拓展资料关键概念解释">八、拓展资料：关键概念解释<a hidden class="anchor" aria-hidden="true" href="#八拓展资料关键概念解释">#</a></h2>
<h3 id="81-阻塞与非阻塞模式">8.1 阻塞与非阻塞模式<a hidden class="anchor" aria-hidden="true" href="#81-阻塞与非阻塞模式">#</a></h3>
<ul>
<li><strong>阻塞模式</strong>：默认情况下，<code>accept()</code> 会阻塞，直到有新的连接或发生错误。</li>
<li><strong>非阻塞模式</strong>：<code>accept()</code> 立即返回，若无连接，则返回 <code>-1</code>，并设置 <code>errno</code> 为 <code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>。</li>
<li><strong>设置方法</strong>：使用 <code>fcntl()</code> 函数设置套接字为非阻塞模式。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="nf">fcntl</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">fcntl</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="82-io-多路复用">8.2 I/O 多路复用<a hidden class="anchor" aria-hidden="true" href="#82-io-多路复用">#</a></h3>
<ul>
<li><strong>概念</strong>：使用单个线程或进程监控多个文件描述符，提高资源利用率。</li>
<li><strong>常用机制</strong>：<code>select()</code>、<code>poll()</code>、<code>epoll()</code>。</li>
<li><strong>应用场景</strong>：高并发服务器，避免为每个连接创建线程或进程。</li>
</ul>
<h3 id="83-accept-与多线程">8.3 <code>accept()</code> 与多线程<a hidden class="anchor" aria-hidden="true" href="#83-accept-与多线程">#</a></h3>
<ul>
<li><strong>问题</strong>：在多线程服务器中，多个线程同时调用 <code>accept()</code> 可能导致竞争。</li>
<li><strong>解决方案</strong>：
<ul>
<li>使用同步机制，如互斥锁，确保只有一个线程调用 <code>accept()</code>。</li>
<li>或者将监听套接字设置为非阻塞模式，结合事件驱动模型。</li>
</ul>
</li>
</ul>
<h3 id="84-so_reuseaddr-与-so_reuseport">8.4 <code>SO_REUSEADDR</code> 与 <code>SO_REUSEPORT</code><a hidden class="anchor" aria-hidden="true" href="#84-so_reuseaddr-与-so_reuseport">#</a></h3>
<ul>
<li><strong><code>SO_REUSEADDR</code></strong>：允许绑定已在使用的地址，常用于服务器重启时快速重新绑定端口。</li>
<li><strong><code>SO_REUSEPORT</code></strong>：允许多个套接字绑定到同一 IP 和端口，常用于多线程或多进程服务器。</li>
</ul>
<hr>
<h2 id="九示例代码多线程服务器示例">九、示例代码：多线程服务器示例<a hidden class="anchor" aria-hidden="true" href="#九示例代码多线程服务器示例">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PORT 8080
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BACKLOG 5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">handle_client</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">conn_fd</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">bytes_read</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 通信处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">((</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="nf">recv</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">send</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">listen_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">socklen_t</span> <span class="n">client_addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建套接字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">listen_fd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket creation failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 绑定地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="nf">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 开始监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="n">BACKLOG</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Server is listening on port %d...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 接受并处理连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="o">*</span><span class="n">conn_fd</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">conn_fd</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addrlen</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Accepted a connection from %s:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="nf">inet_ntoa</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="nf">ntohs</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">handle_client</span><span class="p">,</span> <span class="n">conn_fd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;pthread_create failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">close</span><span class="p">(</span><span class="o">*</span><span class="n">conn_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">conn_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">pthread_detach</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://oheyu.github.io/zh/tags/linux/">Linux</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://oheyu.github.io/zh/posts/tech/inet_pton%E4%B8%8Einet_ntop/">
    <span class="title">« 上一页</span>
    <br>
    <span>Inet_pton与inet_ntop</span>
  </a>
  <a class="next" href="https://oheyu.github.io/zh/posts/tech/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84listen%E5%87%BD%E6%95%B0/">
    <span class="title">下一页 »</span>
    <br>
    <span>服务端的listen函数</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://oheyu.github.io/zh/">史玉浩的个人博客</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
